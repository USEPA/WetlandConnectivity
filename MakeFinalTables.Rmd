---
title: "Make WetPath Tables"
author: "Ryan Hill & Marc Weber"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    theme: yeti
    highlighted: default 
    toc: yes
---

### Set up
```{r, eval=F}
year = '2001'
final_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/FinalTables/WetlandTables/')
# data_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/WetlandPath/Data'
# wetland_tables = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables/'
accum_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/WetlandPath/Accumulation/')
accum_cat = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/WetlandCat/Accumulation/')
# precip_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/WetlandCat/Accumulation/'
lookup_tables = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/WetlandPath/LookupTables/')
# cat_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/NHDPlusCatchmentTables/'

#table_combo = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/CombiningTables/'

files = list.files(accum_path, pattern = 'NLCD'); rpus = c()
for(i in 1:length(files)){
  #print(files[i])
  rpus[i] = substr(files[i], 18, 20)
}
```

### Make rise, run, slope tables (path)
```{r, eval=F}

#Make rise tables (path)
for(i in 1:length(rpus)){
  print(rpus[i])
  elevmax = read.csv(paste0(accum_path, 'Elev_MAX_', rpus[i], '.csv'))
  elevmin = read.csv(paste0(accum_path, 'Elev_MIN_', rpus[i], '.csv'))  
  rise = merge(elevmax, elevmin)
  rise$rise = (rise$MAX - rise$MIN) / 100 #convert to meters
  rise$rise = rise$rise + 0.1
  rise = rise[ ,c('PathID', 'rise')]
  #names(rise) = c('PATHID', 'rise')
  write.csv(rise, paste0(accum_path, 'rise_m_', rpus[i], '.csv'), row.names=F)
}

#Make run tables (path)
for(i in 1:length(rpus)){
  print(rpus[i])
  flmax = read.csv(paste0(accum_path, 'flowlength_m_MAX_', rpus[i], '.csv'))
  flmin = read.csv(paste0(accum_path, 'flowlength_m_MIN_', rpus[i], '.csv'))  
  run = merge(flmax, flmin)
  run$run = (run$MAX - run$MIN) + 15
  run = run[ ,c('PathID', 'run')]
  names(run) = c('PATHID', 'run')
  write.csv(run, paste0(accum_path, 'run_m_', rpus[i], '.csv'), row.names=F)
}

#Make slope tables (path)
for(i in 1:length(rpus)){
  print(rpus[i])
  rise = read.csv(paste0(accum_path, 'rise_m_', rpus[i], '.csv'))
  run = read.csv(paste0(accum_path, 'run_m_', rpus[i], '.csv')) 
  names(rise)[1] = toupper(names(rise)[1])
  slope = merge(rise, run, on='PATHID')
  slope$slope = (slope$rise / slope$run) 
  slope = slope[ ,c('PATHID', 'slope')]
  write.csv(slope, paste0(accum_path, 'slope_', rpus[i], '.csv'), row.names=F)
}
```

### Make Precip and Mannings tables (path)
```{r, eval=F}
library(stringr)
#path_dir = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/WetlandPath/Accumulation'
path_dir = accum_path

variables=list.files(path_dir)

# Mannings (path)
library(foreign)
if (year=='2011') rat <- read.dbf('L:/Priv/CORFiles/Geospatial_Library/Data/Project/StreamCat/LandscapeRasters/QAComplete/nlcd2011.tif.vat.dbf')
if (year=='2001') rat <- read.dbf('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/NLCD2001/nlcd2001.tif.vat.dbf')
names(rat) <- toupper(names(rat))
r <- sapply(rat$VALUE, function(x) paste(c('VALUE_',x),collapse=''))
library(matrixStats)
nlcdlist = variables[grep(year, variables)]
mannings = read.csv('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/old_LookupTables/NLCD_Mannings_Lookup.csv')
head(mannings)
for (i in 1:length(nlcdlist)){
  nlcd = read.csv(paste0(path_dir,'/',nlcdlist[i]))
  head(nlcd)
  missing <- r[is.na(match(r, names(nlcd)))]
  nlcd[,paste(missing)] <- c(0)
  nlcd$Total <- rowSums(nlcd[,2:length(nlcd)])
  
  #calculate %s for each nlcd category
  for (k in 2:length(nlcd)){
    nlcd[,k] = 100.0 * nlcd[,k]/nlcd[,length(nlcd)]
  } 
  nlcd = nlcd[c(1:(length(nlcd)-1))]
  #calculate final mannings geometric mean
  #First raise each mannings to the % of flow path of NLCD type
  for (m in 2:length(nlcd)){
    nlcd[,m] = (mannings$Mannings[match(names(nlcd)[m], mannings$NLCD)])^(nlcd[,m])
  } 
  #Calculate geomean using product
  nlcd$GeoMean = (rowProds(as.matrix(nlcd[,2:17])))^(1/100)
  names(nlcd)[1] = 'PATHID'
  nlcd = nlcd[, c('PATHID','GeoMean')]
  write.csv(nlcd, paste0(path_dir, '/Mannings', str_sub(strsplit(nlcdlist[i],'\\.')[[1]][1],-3),'.csv'))
}

#New precip code (cat)
cat_dir = accum_cat
variables=list.files(cat_dir)
preciplist = variables[grep("US2yr24ha_mm_10x_MEAN_", variables)]
rpus = c()
for(i in 1:length(preciplist)){
  #print(files[i])
  rpus[i] = substr(preciplist[i], 23, 25)
}
for(i in 1:length(rpus)){
  print(files[i])
  precip = read.csv(paste0(cat_dir, 'US2yr24ha_mm_10x_MEAN_', rpus[i], '.csv'))
  precip$PRECIP_2YR24HR_MM = (precip$SUM / precip$COUNT) * 0.1
  lookup = read.csv(paste0(lookup_tables, 'WetlandsWithPath_StreamLink_Lookup_', rpus[i], '.csv'))
  names(precip) = toupper(names(precip))
  precip$PATHID = lookup$STRMLNK_ID[match(precip$BASINID, lookup$WET_ID)]
  precip = precip[, c('BASINID','PATHID','PRECIP_2YR24HR_MM')]
  write.csv(precip, paste0(accum_path, 'Precip2Yr24hr_', rpus[i], '.csv'), row.names=F)
}
```

### Make combine to make start of shallow table (path)
```{r, eval=F}
for(i in 1:length(rpus)){
  print(rpus[i])
  run = read.csv(paste0(accum_path, 'run_m_', rpus[i], '.csv'))
  slope = read.csv(paste0(accum_path, 'slope_', rpus[i], '.csv'))
  porosity = read.csv(paste0(accum_path, 'AvgPorosity_MAX_', rpus[i], '.csv'))
  names(porosity) <- c('PATHID', 'porosity_max')
  perm = read.csv(paste0(accum_path, 'AvgPerm_MIN_', rpus[i], '.csv'))
  perm$MIN = perm$MIN / 1000
  names(perm) <- c('PATHID', 'perm_min')
  
  out_table = run
  out_table = merge(out_table, slope)
  out_table = merge(out_table, porosity)
  out_table = merge(out_table, perm)
  
 write.csv(out_table, paste0(final_path, 'ShallowFlow_', rpus[i], '.csv'), row.names=F)
}
```

### Make shallow travel time (path)
```{r, eval=F}
for(i in 1:length(rpus)){
  print(rpus[i])
  travel = read.csv(paste0(final_path, 'ShallowFlow_', rpus[i], '.csv'))
  
  #print(summary(travel))
  
  travel$perm_min = travel$perm_min + 0.1

  travel$slope = travel$slope + 0.01
  
  travel$t_shallow = travel$run / ((travel$perm_min / travel$porosity_max) * travel$slope)
  
  print(summary(travel))
  print(nrow(is.infinite(travel$t_shallow)))
  write.csv(travel, paste0(final_path, 'ShallowFlow_', rpus[i], '.csv'), row.names=F)
}
```

### Make flow type table (path)
```{r, eval=F}
library(dplyr)
r = c('VALUE_11', 'VALUE_12', 'VALUE_21', 'VALUE_22')

for(i in 1:length(rpus)){
  
  print(rpus[i])
  flow_cls = read.csv(paste0(accum_path, 'BdrckPerm_4_classes_Alb83_PERCENT_', rpus[i], '.csv'))   
  missing <- r[is.na(match(r, names(flow_cls)))]
  flow_cls[,paste(missing)] <- c(0)
  
  flow_cls = flow_cls[, c('PathID', r)] #make in right order
  
  flow_cls[ ,2:5] = prop.table(as.matrix(flow_cls[ ,2:5]), margin = 1) * 100
  flow_cls$Overland = flow_cls$VALUE_12 + flow_cls$VALUE_22
  flow_cls = select(flow_cls, -VALUE_12, -VALUE_22)
  #Make sure in correct order
  flow_cls = flow_cls[, c('PathID','VALUE_11','VALUE_21','Overland')]  
  names(flow_cls)[1:3] <- c('PATHID','Shallow','ShallowDeep')
  type_names = names(flow_cls)[2:4]  
  flow_cls = na.omit(flow_cls)  
  flow_cls$DomFlow = type_names[apply(flow_cls[, 2:4], 1, which.max)]
  print(summary(flow_cls))
  write.csv(flow_cls, paste0(final_path, 'FlowClass_', rpus[i], '.csv'), row.names=F)
}   
```

### Make Wetland path Drain Class table
```{r, eval=F}
library(dplyr)
r = c('VALUE_0', 'VALUE_1', 'VALUE_2', 'VALUE_3')

for(i in 1:length(rpus)){
  
  print(rpus[i])
  flow_cls = read.csv(paste0(accum_path, 'DrainClass_PERCENT_', rpus[i], '.csv'))   
  missing <- r[is.na(match(r, names(flow_cls)))]
  flow_cls[,paste(missing)] <- c(0)
  
  flow_cls = flow_cls[, c('PathID', r)] #make in right order
  print(summary(flow_cls))
  
  flow_cls[ ,2:5] = prop.table(as.matrix(flow_cls[ ,2:5]), margin = 1) * 100
 
  type_names = names(flow_cls)[2:5]  
  type_num = c(0,1,2,3)
  flow_cls = na.omit(flow_cls)  
  flow_cls$DomFlow = type_names[apply(flow_cls[, 2:5], 1, which.max)]
  #flow_cls$DomCls = type_num[apply(flow_cls[, 2:5], 1, which.max)]
  print(summary(flow_cls))
  write.csv(flow_cls, paste0(final_path, 'DrainClass_', rpus[i], '.csv'), row.names=F)
}     
```

### Make combine to make start of overland table
```{r, eval=F}
for(i in 1:length(rpus)){
  print(rpus[i])
  run = read.csv(paste0(accum_path, 'run_m_', rpus[i], '.csv'))
  slope = read.csv(paste0(accum_path, 'slope_', rpus[i], '.csv'))
  slope$slope = slope$slope + 0.01
  man = read.csv(paste0(accum_path, 'Mannings', rpus[i], '.csv'))
  man = man[ , c('PATHID','GeoMean')]
  names(man) <- c('PATHID','Manning')
  precip = read.csv(paste0(accum_path, 'Precip2Yr24hr_', rpus[i], '.csv'))
  precip = precip[!is.na(precip$PATHID),]
  # precip 2yr24hr values already divided by 10 when making accumulation tables, so use as is
  #precip = precip[c(2:4)]
  out_table = precip
  out_table = merge(out_table, slope, by='PATHID', all.x=TRUE)
  out_table = merge(out_table, man, by='PATHID', all.x=TRUE)
  out_table = merge(out_table, run, by='PATHID', all.x=TRUE)
  print(summary(out_table))
  write.csv(out_table, paste0(final_path, 'OverlandFlow_', rpus[i], '.csv'), row.names=F)
}
```

### Make overland travel time
```{r, eval=F}
for(i in 1:length(rpus)){
  print(rpus[i])
  travel = read.csv(paste0(final_path, 'OverlandFlow_', rpus[i], '.csv'))
  travel$t_overland = 0.0913*(((travel$Manning * travel$run)^0.8)/((travel$PRECIP_2YR24HR_MM)^0.5 * (travel$slope)^0.4))
  print(summary(travel))
  print(nrow(is.infinite(travel$t_shallow)))
  write.csv(travel, paste0(final_path, 'OverlandFlow_', rpus[i], '.csv'), row.names=F)
}
```

### Make levee influence tables
```{r, eval=F}
lookup_dir = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/WetlandPath/LookupTables')
lookup_list = list.files(lookup_dir)
lookup_list = lookup_list[grep("WetlandsWithPath", lookup_list)]
for(i in 1:length(rpus)){
  print(rpus[i])
  lookup = read.csv(paste0(lookup_dir, '/',lookup_list[i]))
  lookup = lookup[c(2)]
  names(lookup) = 'PATHID'
  levee = read.csv(paste0(accum_path, 'LeveeProximity_MEAN_', rpus[i], '.csv'))  
  lookup$LeveeInfuence = levee$SUM[match(lookup$PATHID,levee$PathID)]
  if (! "LeveeInfuence" %in% colnames(lookup)) lookup$LeveeInfuence = 0
  lookup$LeveeInfuence[lookup$LeveeInfuence > 0] = 1
  lookup$LeveeInfuence[is.na(lookup$LeveeInfuence)] = 0
  levee = lookup
  print(summary(levee))
  write.csv(levee, paste0(final_path, 'LeveeInfluence_', rpus[i], '.csv'), row.names=F)
}
```

### Make canal / ditch influence tables
```{r, eval=F}
lookup_dir = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/WetlandPath/LookupTables')
lookup_list = list.files(lookup_dir)
lookup_list = lookup_list[grep("WetlandsWithPath", lookup_list)]
for(i in 1:length(rpus)){
  print(rpus[i])
  lookup = read.csv(paste0(lookup_dir, '/',lookup_list[i]))
  lookup = lookup[c(2)]
  names(lookup) = 'PATHID'
  canals = read.csv(paste0(accum_path, 'CanalsDitches_MEAN_', rpus[i], '.csv'))  
  lookup$CanalInfluence = canals$SUM[match(lookup$PATHID,canals$PathID)]
  if (! "CanalInfluence" %in% colnames(lookup)) lookup$CanalInfluence = 0
  lookup$CanalInfluence[lookup$CanalInfluence > 0] = 1
  lookup$CanalInfluence[is.na(lookup$CanalInfluence)] = 0
  canals = lookup
  canals <- canals[complete.cases(canals),]
  print(summary(canals))
  write.csv(canals, paste0(final_path, 'CanalInfluence_', rpus[i], '.csv'), row.names=F)
}
```

### Make wetland basin runoff freq table
### Classes [0 = least likely to flood; 4 = most likely to flood]  0: -1600 to -1200 (mm) 1: -1200 to -852   2: -852 to -505  3: -505 to -157   4: -157 to 200
```{r, eval=F}

for(i in 1:length(rpus)){
  cat_dir = accum_cat
  print(rpus[i])
  runoff_freq = read.csv(paste0(accum_cat, 'RunoffFreq_MEAN_', rpus[i], '.csv'))   
  runoff_freq$RUNOFF_FREQ = (runoff_freq$SUM / runoff_freq$COUNT) 
  runoff_freq$RUNOFF_CAT <- cut(runoff_freq$RUNOFF_FREQ, breaks=c(-1600,-1200, -852, -505, -157, 200), include.lowest=TRUE)
  table(runoff_freq$RUNOFF_CAT)
  levels(runoff_freq$RUNOFF_CAT) <- c('0','1','2','3','4')
  runoff_freq <- runoff_freq[c(1,5)]
  print(summary(runoff_freq))
  write.csv(runoff_freq, paste0(final_path, 'RunoffFreq_', rpus[i], '.csv'), row.names=F)  
}     
```

### Make wetland basin imperviousness tables
```{r, eval=F}
for(i in 1:length(rpus)){
  print(rpus[i])
  imperv = read.csv(paste0(accum_cat, 'Impervious_',year,'_MEAN_', rpus[i], '.csv'))    
  imperv$BasinImperv = imperv$SUM / imperv$COUNT
  names(imperv)[1] = 'BASINID'
  imperv = imperv[ , c('BASINID','BasinImperv')]  
  print(summary(imperv))
  write.csv(imperv, paste0(final_path, 'Imperviousness_', rpus[i], '.csv'), row.names=F)
}
```

### Make wetland basin ag drainage tables
```{r, eval=F}

r = c('VALUE_0', 'VALUE_1')

for(i in 1:length(rpus)){
  print(rpus[i])
  ad = read.csv(paste0(accum_cat, 'AgDrainage_PERCENT_', rpus[i], '.csv'))  
  missing <- r[is.na(match(r, names(ad)))]
  ad[,paste(missing)] <- c(0)
  ad[ ,2:3] = prop.table(as.matrix(ad[ ,2:3]), margin = 1) * 100
  ad = ad[, c('BasinID','VALUE_1')]
  names(ad) = c('BASINID','PctAgDrainBasin')
  print(summary(ad))
  write.csv(ad, paste0(final_path, 'AgDrainage_Basin_', rpus[i], '.csv'), row.names=F)
}
```

### Make wetland flowpath ag drainage tables (isolated wetlands)
```{r, eval=F}

r = c('VALUE_0', 'VALUE_1')

for(i in 1:length(rpus)){
  print(rpus[i])
  ad = read.csv(paste0(accum_path, 'AgDrain_PERCENT_', rpus[i], '.csv'))  
  missing <- r[is.na(match(r, names(ad)))]
  ad[,paste(missing)] <- c(0)
  ad[ ,2:3] = prop.table(as.matrix(ad[ ,2:3]), margin = 1) * 100
  ad = ad[, c('PathID','VALUE_1')]
  names(ad) = c('PATHID','PctAgDrainPath')
  write.csv(ad, paste0(final_path, 'AgDrainage_Path_', rpus[i], '.csv'), row.names=F)
  
}
```

### Make basin area tables 
```{r, eval=F}
cat_dir = accum_cat
for(i in 1:length(rpus)){
  print(rpus[i])
  precip = read.csv(paste0(cat_dir, 'US2yr24ha_mm_10x_MEAN_', rpus[i], '.csv'))
  precip$AreaSqKm = (precip$COUNT * 900) / 1e6
  precip = precip[, c('BasinID','AreaSqKm')]
  names(precip)[1] = 'BASINID'
  write.csv(precip, paste0(final_path, 'BasinAreaSqKm_', rpus[i], '.csv'), row.names=F)
}
```

### Tie NHDPlus Catchment COMID to WET_ID for wetlands
```{r, eval=F}
library(foreign)
library(rgdal)
library(raster)
library(rgeos)
nhd_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/RESOURCE/PHYSICAL/HYDROLOGY/NHDPlusV21'
wetpoints_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/WetlandPoints')
lookup_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/WetlandPath/LookupTables/')
rpu_lookup_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'1/WetlandPath/LookupTables/')
out_lookup = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/LookupTables/')

hydro.rgns <- c("01","02","03S","03N","03W","04","05","06","07","08","09","10L","10U","11","12","13","14","15","16","17","18")
rgns <- c("NE","MA","SA","SA","SA","GL","MS","MS","MS","MS","SR","MS","MS","MS","TX","RG","CO","CO","GB","PN","CA")
for (i in 1:21){
  print(hydro.rgns[i])
    #Read in catchment DBF
  cats = raster(paste0(nhd_path,"/NHDPlus",rgns[i],"/NHDPlus",hydro.rgns[i],"/NHDPlusCatchment/cat"))
  catpolys = readOGR(paste0(nhd_path,"/NHDPlus",rgns[i],"/NHDPlus",hydro.rgns[i],"/NHDPlusCatchment"),'Catchment')
  #Read in wetland pour points
  files = list.files(paste0(nhd_path,"/NHDPlus",rgns[i],"/NHDPlus",hydro.rgns[i]), pattern = 'FdrFac')
  files = files[!grepl('\\.txt$',files) & ! grepl('\\.7z$',files)]
  vpu_rpus = substr(files, 14,16)
  for (k in 1:length(vpu_rpus)){
    wetpoints = readOGR(wetpoints_path, paste0('WetlandPoints', vpu_rpus[k]))
    wetpoints = spTransform(wetpoints, CRS(projection(cats)))
    wetID_CatID = extract(cats, wetpoints, df=TRUE)
    wetID_CatID$COMID = catpolys$FEATUREID[match(wetID_CatID$cat,catpolys$GRIDCODE)]
    wetID_CatID = wetID_CatID[c('COMID')]
    WetID_COMID = cbind(wetpoints@data, wetID_CatID)
    WetID_COMID = WetID_COMID[c('GRID_CODE','COMID')]
    names(WetID_COMID)[1] = 'WetID'
    # NOTE - there are wetlands with NAs for catchments - this is fine - the wetlands lie outside of NHDPlus catchments.
    write.csv(WetID_COMID, paste0(out_lookup, 'WetlandsID_COMID_', vpu_rpus[k], '.csv'), row.names=F)
  }
}
```

### Add Ecoregion to final lookup tables
```{r, eval=F}
library(rgdal); library(rgeos)
out_lookup = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/LookupTables/')
wetpoints_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/WetlandPoints')
eco9_lookup = read.csv('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/eco9_all.csv')
eco9_sp = readOGR('L:/Priv/CORFiles/Geospatial_Library/Data/RESOURCE/PHYSICAL/ECOREGIONS','Aggr_Eco9_2015')
eco9 = gSimplify(eco9_sp, 1000, topologyPreserve=TRUE)
eco9 = gBuffer(eco9, byid=TRUE,width=15000)
eco9_sp = SpatialPolygonsDataFrame(eco9, eco9_sp@data)
OverUpdate <- function(points, polys) {
  pointpoly <- over(points, polys)
  points@data <- data.frame(points@data, pointpoly)
}
for(i in 1:length(rpus)){
  print(rpus[i])
  lookup = read.csv(paste0(out_lookup, 'WetlandsID_COMID_', rpus[i], '.csv'))
  lookup$WSA_9 = eco9_lookup$WSA_9[match(lookup$COMID, eco9_lookup$COMID)]
  if (any(is.na(lookup$WSA_9))){
    print(paste0('grab missing WSA9 for ',rpus[i]))
    # get nearest WSA9 where missing
    missing <- lookup[is.na(lookup$WSA_9),]
    wetpoints = readOGR(wetpoints_path, paste0('WetlandPoints', rpus[i]))
    missing <- wetpoints[wetpoints$GRID_CODE %in% missing$WetID,]
    missing@data = OverUpdate(missing, eco9_sp)
    if (any(is.na(missing$WSA9))){
      # just check if missing any - looks like we aren't
      print(paste0('missing a few in ',rpus[i]))
    }
  }
  lookup$WSA_9[is.na(lookup$WSA_9)] = missing$WSA9[match(lookup$WetID[is.na(lookup$WSA_9)],missing$GRID_CODE)]
  write.csv(lookup, paste0(out_lookup, 'WetlandsID_COMID_', rpus[i], '.csv'), row.names=F)
}
```

### Add COMID, Eco to FlowType tables 
```{r, eval=F}
table_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/FinalTables/WetlandTables/')
lookup_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/WetlandPath/LookupTables/')
comeco_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/LookupTables/')

for(i in 1:length(rpus)){
  print(rpus[i])
  
  in_table = read.csv(paste0(table_path, 'FlowClass_', rpus[i], '.csv'))
  
  nrow(in_table)
  head(in_table)
  allwet = read.csv(paste0(lookup_path, 'AllWetlands_StreamLink_Lookup_', rpus[i], '.csv'))
  comeco = read.csv(paste0(comeco_path, 'WetlandsID_COMID_', rpus[i], '.csv'))
  head(allwet)
  head(comeco)
  in_table = merge(in_table, allwet, by.x='PATHID', by.y='STRMLNK_ID',all.y=T)  
  in_table$Riparian = 0
  in_table = merge(in_table, comeco, by.x='WET_ID', by.y='WetID',all.y=T)  
  in_table = in_table[ , c('PATHID','WET_ID','COMID','WSA_9', 'Shallow', 'ShallowDeep', 'Overland', 'Riparian', 'DomFlow')]
  summary(in_table)
  in_table$Shallow[is.na(in_table$PATHID)] = 0 
  in_table$ShallowDeep[is.na(in_table$PATHID)] = 0
  in_table$Overland[is.na(in_table$PATHID)] = 0
  in_table$Riparian[is.na(in_table$PATHID)] = 100
  in_table$DomFlow = as.character(in_table$DomFlow)
  in_table$DomFlow[is.na(in_table$PATHID)] = 'Riparian'
  print(summary(in_table))
  write.csv(in_table, paste0(table_path, 'FlowClass_', rpus[i], '.csv'), row.names=F)
}
```

### Add COMID and eco9 to Overland Flow tables
```{r, eval=F}
table_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/FinalTables/WetlandTables/')
lookup_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/WetlandPath/LookupTables/')
comeco_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/LookupTables/')

for(i in 1:length(rpus)){
  print(rpus[i])
  
  in_table = read.csv(paste0(table_path, 'OverlandFlow_', rpus[i], '.csv'))

  nrow(in_table)
  head(in_table)
  allwet = read.csv(paste0(lookup_path, 'AllWetlands_StreamLink_Lookup_', rpus[i], '.csv'))
  comeco = read.csv(paste0(comeco_path, 'WetlandsID_COMID_', rpus[i], '.csv'))
  head(allwet)
  head(comeco)
  in_table = merge(in_table, allwet, by.x='PATHID', by.y='STRMLNK_ID',all.x=T)  
  in_table = merge(in_table, comeco, by.x='WET_ID', by.y='WetID',all.y=T) 
  in_table$Riparian = 0
  in_table = in_table[ , c('PATHID','WET_ID','COMID','WSA_9', 'PRECIP_2YR24HR_MM', 'slope', 'Manning', 'Riparian','run', 't_overland')]
  in_table$PRECIP_2YR24HR_MM[is.na(in_table$PATHID)] = 0
  in_table$slope[is.na(in_table$PATHID)] = 0
  in_table$Manning[is.na(in_table$PATHID)] = 0
  in_table$Riparian[is.na(in_table$PATHID)] = 100
  in_table$run[is.na(in_table$PATHID)] = 0
  in_table$t_overland[is.na(in_table$PATHID)] = 0
  write.csv(in_table, paste0(table_path, 'OverlandFlow_', rpus[i], '.csv'), row.names=F)
  }
```

#Add COMID and eco9 to tables
Subsurface Flow
```{r, eval=F}
table_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/FinalTables/WetlandTables/')
lookup_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/WetlandPath/LookupTables/')
comeco_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/LookupTables/')

for(i in 1:length(rpus)){
  print(rpus[i])
  
  in_table = read.csv(paste0(table_path, 'ShallowFlow_', rpus[i], '.csv'))

  nrow(in_table)
  head(in_table)
  allwet = read.csv(paste0(lookup_path, 'AllWetlands_StreamLink_Lookup_', rpus[i], '.csv'))
  comeco = read.csv(paste0(comeco_path, 'WetlandsID_COMID_', rpus[i], '.csv'))
  head(allwet)
  head(comeco)

  in_table = merge(in_table, allwet, by.x='PATHID', by.y='STRMLNK_ID',all.x=T)  
  in_table = merge(in_table, comeco, by.x='WET_ID', by.y='WetID',all.y=T) 
  in_table$Riparian = 0
  in_table = in_table[ , c('PATHID','WET_ID','COMID','WSA_9', 'run', 'slope', 'porosity_max', 'Riparian','perm_min', 't_shallow')]
  in_table$run[is.na(in_table$PATHID)] = 0
  in_table$slope[is.na(in_table$PATHID)] = 0
  in_table$porosity_max[is.na(in_table$PATHID)] = 0
  in_table$perm_min[is.na(in_table$PATHID)] = 0
  in_table$t_shallow[is.na(in_table$PATHID)] = 0
  in_table$Riparian[is.na(in_table$PATHID)] = 100
  write.csv(in_table, paste0(table_path, 'ShallowFlow_', rpus[i], '.csv'), row.names=F)
  }
```

#Add COMID and eco9 to tables
Imperviousness
```{r, eval=F}
table_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/FinalTables/WetlandTables/')
lookup_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/WetlandPath/LookupTables/')
comeco_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/LookupTables/')


for(i in 1:length(rpus)){
  print(rpus[i])
  
  in_table = read.csv(paste0(table_path, 'Imperviousness_', rpus[i], '.csv'))

  nrow(in_table)
  head(in_table)
  
  allwet = read.csv(paste0(lookup_path, 'AllWetlands_StreamLink_Lookup_', rpus[i], '.csv'))
  comeco = read.csv(paste0(comeco_path, 'WetlandsID_COMID_', rpus[i], '.csv'))
  head(allwet)
  head(comeco)

  in_table = merge(in_table, allwet, by.x='BASINID', by.y='WET_ID',all.x=T)  
  in_table = merge(in_table, comeco, by.x='BASINID', by.y='WetID',all.y=T)
  in_table$Riparian = 0
  names(in_table)[1] = 'WET_ID'
  names(in_table)[3] = 'PATHID'
  in_table = in_table[ , c('WET_ID','PATHID','COMID','WSA_9', 'Riparian','BasinImperv')]
  in_table$Riparian[is.na(in_table$PATHID)] = 100
  write.csv(in_table, paste0(table_path, 'Impervious_', rpus[i], '.csv'), row.names=F)
  }
```

#Add COMID and eco9 to tables
Ag Drainage Basin
```{r, eval=F}
table_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/FinalTables/WetlandTables/')
lookup_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/WetlandPath/LookupTables/')
comeco_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/LookupTables/')

for(i in 1:length(rpus)){
  print(rpus[i])
  
  in_table = read.csv(paste0(table_path, 'AgDrainage_Basin_', rpus[i], '.csv'))

  nrow(in_table)
  head(in_table)
  allwet = read.csv(paste0(lookup_path, 'AllWetlands_StreamLink_Lookup_', rpus[i], '.csv'))
  comeco = read.csv(paste0(comeco_path, 'WetlandsID_COMID_', rpus[i], '.csv'))
  head(allwet)
  head(comeco)

  in_table = merge(in_table, allwet, by.x='BASINID', by.y='WET_ID',all.x=T)  
  in_table = merge(in_table, comeco, by.x='BASINID', by.y='WetID',all.y=T)
  in_table$Riparian = 0
  names(in_table)[1] = 'WET_ID'
  names(in_table)[3] = 'PATHID'
  in_table = in_table[ , c('WET_ID','PATHID','COMID','WSA_9', 'Riparian','PctAgDrainBasin')]
  in_table$Riparian[is.na(in_table$PATHID)] = 100
  write.csv(in_table, paste0(table_path, 'AgDrainage_Basin_', rpus[i], '.csv'), row.names=F)
  }
```

#Add COMID and eco9 to tables
Ag Drainage Path
```{r, eval=F}
table_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/FinalTables/WetlandTables/')
lookup_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/WetlandPath/LookupTables/')
comeco_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/LookupTables/')

for(i in 1:length(rpus)){
  print(rpus[i])
  
  in_table = read.csv(paste0(table_path, 'AgDrainage_Path_', rpus[i], '.csv'))

  nrow(in_table)
  head(in_table)
  allwet = read.csv(paste0(lookup_path, 'AllWetlands_StreamLink_Lookup_', rpus[i], '.csv'))
  comeco = read.csv(paste0(comeco_path, 'WetlandsID_COMID_', rpus[i], '.csv'))
  head(allwet)
  head(comeco)

  in_table = merge(in_table, allwet, by.x='PATHID', by.y='STRMLNK_ID',all.x=T)  
  in_table = merge(in_table, comeco, by.x='WET_ID', by.y='WetID',all.y=T) 
  in_table$Riparian = 0
  in_table = in_table[ , c('WET_ID','PATHID','COMID','WSA_9', 'Riparian','PctAgDrainPath')]
  in_table$PctAgDrainPath[is.na(in_table$PATHID)] = 0
  in_table$Riparian[is.na(in_table$PATHID)] = 100
  write.csv(in_table, paste0(table_path, 'AgDrainage_Path_', rpus[i], '.csv'), row.names=F)
  }
```

#Add COMID and eco9 to tables
FloodFreq Basin
```{r, eval=F}
table_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/FinalTables/WetlandTables/')
lookup_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/WetlandPath/LookupTables/')
comeco_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/LookupTables/')

for(i in 1:length(rpus)){
  print(rpus[i])
  
  in_table = read.csv(paste0(table_path, 'FloodFreq_', rpus[i], '.csv'))

  nrow(in_table)
  head(in_table)
  allwet = read.csv(paste0(lookup_path, 'AllWetlands_StreamLink_Lookup_', rpus[i], '.csv'))
  comeco = read.csv(paste0(comeco_path, 'WetlandsID_COMID_', rpus[i], '.csv'))
  head(allwet)
  head(comeco)

  in_table = merge(in_table, allwet, by.x='BasinID', by.y='WET_ID',all.x=T)  
  in_table = merge(in_table, comeco, by.x='BasinID', by.y='WetID',all.y=T)
  in_table$Riparian = 0
  names(in_table)[1] = 'WET_ID'
  names(in_table)[2] = 'DomFldFreqCls'
  names(in_table)[3] = 'PATHID'
  
  in_table = in_table[ , c('WET_ID','PATHID','COMID','WSA_9', 'Riparian','DomFldFreqCls')]
  in_table$Riparian[is.na(in_table$PATHID)] = 100
  write.csv(in_table, paste0(table_path, 'FloodFreq_', rpus[i], '.csv'), row.names=F)
  }
```

#Add COMID and eco9 to tables
DrainClass Path
```{r, eval=F}
table_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/FinalTables/WetlandTables/')
lookup_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/WetlandPath/LookupTables/')
comeco_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/LookupTables/')

for(i in 1:length(rpus)){
  print(rpus[i])
  
  in_table = read.csv(paste0(table_path, 'DrainClass_', rpus[i], '.csv'))

  nrow(in_table)
  head(in_table)
  allwet = read.csv(paste0(lookup_path, 'AllWetlands_StreamLink_Lookup_', rpus[i], '.csv'))
  comeco = read.csv(paste0(comeco_path, 'WetlandsID_COMID_', rpus[i], '.csv'))
  head(allwet)
  head(comeco)

  in_table = merge(in_table, allwet, by.x='PathID', by.y='STRMLNK_ID',all.x=T)  
  in_table = merge(in_table, comeco, by.x='WET_ID', by.y='WetID',all.y=T) 
  in_table$Riparian = 0
  in_table = in_table[c(1:2,7:10)]
  names(in_table)[2] = 'PATHID'
  names(in_table)[3] = 'DomDrainClass'
  in_table = in_table[ , c('WET_ID','PATHID','COMID','WSA_9', 'Riparian','DomDrainClass')]
  in_table$Riparian[is.na(in_table$PATHID)] = 100
  write.csv(in_table, paste0(table_path, 'DrainClass_', rpus[i], '.csv'), row.names=F)
  }
```

#Add COMID and eco9 to tables
LeveeInfluence
```{r, eval=F}
table_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/FinalTables/WetlandTables/')
lookup_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/WetlandPath/LookupTables/')
comeco_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/LookupTables/')

for(i in 1:length(rpus)){
  print(rpus[i])
  
  in_table = read.csv(paste0(table_path, 'LeveeInfluence_', rpus[i], '.csv'))

  nrow(in_table)
  head(in_table)
  allwet = read.csv(paste0(lookup_path, 'AllWetlands_StreamLink_Lookup_', rpus[i], '.csv'))
  comeco = read.csv(paste0(comeco_path, 'WetlandsID_COMID_', rpus[i], '.csv'))
  head(allwet)
  head(comeco)

  in_table = merge(in_table, allwet, by.x='PATHID', by.y='STRMLNK_ID',all.x=T)  
  in_table = merge(in_table, comeco, by.x='WET_ID', by.y='WetID',all.y=T) 
  in_table$Riparian = 0
  names(in_table)[3] = 'LeveeInfluence'
  in_table = in_table[ , c('WET_ID','PATHID','COMID','WSA_9', 'Riparian','LeveeInfluence')]
  in_table$LeveeInfluence[is.na(in_table$PATHID)] = 0
  in_table$Riparian[is.na(in_table$PATHID)] = 100
  write.csv(in_table, paste0(table_path, 'LeveeInfluence_', rpus[i], '.csv'), row.names=F)
  }
```

#Add COMID and eco9 to tables
Wetland basin areas
```{r, eval=F}
table_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/FinalTables/WetlandTables/')
lookup_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/WetlandPath/LookupTables/')
comeco_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/LookupTables/')

for(i in 1:length(rpus)){
  print(rpus[i])
  
  in_table = read.csv(paste0(table_path, 'BasinAreaSqKm_', rpus[i], '.csv'))

  nrow(in_table)
  head(in_table)
  nrow(in_table)
  head(in_table)
  allwet = read.csv(paste0(lookup_path, 'AllWetlands_StreamLink_Lookup_', rpus[i], '.csv'))
  comeco = read.csv(paste0(comeco_path, 'WetlandsID_COMID_', rpus[i], '.csv'))
  head(allwet)
  head(comeco)

  in_table = merge(in_table, allwet, by.x='BASINID', by.y='WET_ID',all.x=T)  
  in_table = merge(in_table, comeco, by.x='BASINID', by.y='WetID',all.y=T)
  in_table$Riparian = 0
  names(in_table)[1] = 'WET_ID'
  names(in_table)[3] = 'PATHID'
  in_table = in_table[, c('WET_ID','COMID','PATHID','WSA_9', 'AreaSqKm', 'Riparian')]
  in_table$Riparian[is.na(in_table$PATHID)] = 100
  in_table$AreaSqKm[is.na(in_table$PATHID)] = 0
  write.csv(in_table, paste0(table_path, 'WetBasinArea_', rpus[i], '.csv'), row.names=F)
  }
```




#--------------------------Added 25 Jan 2017 ------------------------------------------------------------------------------
### Add State to final lookup tables
```{r, eval=F}
library(rgdal); library(rgeos)
  #Define update function for points that miss polygons
OverUpdate <- function(points, polys) {
  pointpoly <- over(points, polys)
  points@data <- data.frame(points@data, pointpoly)
}

out_lookup = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/LookupTables/')
wetpoints_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/WetlandPoints')
#eco9_lookup = read.csv('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/eco9_all.csv')
states_sp = readOGR('L:/Priv/CORFiles/Geospatial_Library/Data/RESOURCE/POLITICAL/BOUNDARIES/NATIONAL','TIGER_2010_State_Boundaries')
states_sp = states_sp[!states_sp$STUSPS10 %in% c('AK', 'HI', 'PR'),]
states_sp = states_sp[, c('STUSPS10')]
states_sp = spTransform(states_sp, CRS("+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs +ellps=GRS80 +towgs84=0,0,0"))
states_buf = gSimplify(states_sp, 1000, topologyPreserve=TRUE)
states_buf = gBuffer(states_buf, byid=TRUE,width=15000)
states_buf = SpatialPolygonsDataFrame(states_buf, states_sp@data)

for(i in 1:length(rpus)){
  print(rpus[i])
  wetpoints = readOGR(wetpoints_path, paste0('WetlandPoints', rpus[i]))
  #wetID_stateID = extract(states_sp, wetpoints, df=TRUE)
  wetID_stateID2 <- over(wetpoints, states_sp)
  wetID_stateID2 = wetID_stateID2[ , c('STUSPS10')] 
  wetpoints$State = cbind(wetpoints, wetID_stateID2)
  
  #-----STOPPED HERE-----
  # NEED TO EXTRACT THE POINT ID AND THE STATE ID. 
  # It's not clear what point.id in the df wetID_stateID is referring to. Is it a 
  
  wetID_stateID = wetID_stateID[ , c('STUSPS10')] 
  
  
  
  lookup = read.csv(paste0(out_lookup, 'WetlandsID_COMID_', rpus[i], '.csv'))
  lookup$WSA_9 = eco9_lookup$WSA_9[match(lookup$COMID, eco9_lookup$COMID)]
  if (any(is.na(lookup$WSA_9))){
    print(paste0('grab missing WSA9 for ',rpus[i]))
    # get nearest WSA9 where missing
    missing <- lookup[is.na(lookup$WSA_9),]
    
    missing <- wetpoints[wetpoints$GRID_CODE %in% missing$WetID,]
    missing@data = OverUpdate(missing, eco9_sp)
    if (any(is.na(missing$WSA9))){
      # just check if missing any - looks like we aren't
      print(paste0('missing a few in ',rpus[i]))
    }
  }
  lookup$WSA_9[is.na(lookup$WSA_9)] = missing$WSA9[match(lookup$WetID[is.na(lookup$WSA_9)],missing$GRID_CODE)]
  write.csv(lookup, paste0(out_lookup, 'WetlandsID_COMID_', rpus[i], '.csv'), row.names=F)
}
```
















#WE DON'T NEED AFTER HERE, IGNORE

#Make cathment tables
```{r, eval=F}
library(dplyr)
old_lookup = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/old_LookupTables/'
lookup_tables = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables_final/'
master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
wet_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables_final/'
cat_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/NHDPlusCatchmentTables/'


# overland
master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
for(i in 1:length(rpus)){
  print(rpus[i])
  travel = read.csv(paste0(wet_path, 'OverlandFlow_', rpus[i], '.csv'))
  travel2 = travel[travel$Riparian != 100, ]
  #travel = travel[!is.na(travel$t_overland), ]
  #cat_lookup = read.csv(paste0(lookup_tables, 'Wetlands_NHDPlusCat_Lookup_', rpus[i], '.csv'))
  #travel$COMID = cat_lookup$COMID[match(travel$WETID, cat_lookup$WET_ID)]
  if (i==1){
    final = group_by(travel,COMID)
    final = summarize(final, t_overland_mean_all = mean(t_overland), t_overland_med_all = median(t_overland))
    
    add = group_by(travel2, COMID)
    add = summarize(add, t_overland_mean_iso = mean(t_overland), t_overland_med_iso = median(t_overland))
    
    final = merge(final, add, all=T)
    
    final$WSA_9 = master_table$WSA_9[match(final$COMID, master_table$COMID)]
  }
  if (i> 1){
    temp = group_by(travel,COMID)
    temp = summarize(temp, t_overland_mean_all = mean(t_overland), t_overland_med_all = median(t_overland))
    
    add = group_by(travel2, COMID)
    add = summarize(add, t_overland_mean_iso = mean(t_overland), t_overland_med_iso = median(t_overland))
    
    temp = merge(temp, add, all=T)
    
    temp$WSA_9 = master_table$WSA_9[match(temp$COMID, master_table$COMID)]
    final = rbind(final, temp)
  } 
}

master_table$t_overland_mean_all = final$t_overland_mean_all[match(master_table$COMID, final$COMID)]
master_table$t_overland_med_all = final$t_overland_med_all[match(master_table$COMID, final$COMID)]
master_table$t_overland_mean_iso = final$t_overland_mean_iso[match(master_table$COMID, final$COMID)]
master_table$t_overland_med_iso = final$t_overland_med_iso[match(master_table$COMID, final$COMID)]

write.csv(master_table, paste0(cat_path, 'OverlandFlow.csv'), row.names=F)
rmNA = na.omit(master_table)
write.csv(rmNA, file = paste0(cat_path, 'OverlandFlow_narm.csv'), row.names=F)


# shallow
master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
for(i in 1:length(rpus)){
  print(rpus[i])
  travel = read.csv(paste0(wet_path, 'ShallowFlow_', rpus[i], '.csv'))
  travel2 = travel[travel$Riparian != 100, ]
#   travel = travel[!is.na(travel$t_shallow), ]
#   cat_lookup = read.csv(paste0(lookup_tables, 'Wetlands_NHDPlusCat_Lookup_', rpus[i], '.csv'))
#   travel$COMID = cat_lookup$COMID[match(travel$WETID, cat_lookup$WET_ID)]
  if (i==1){
    final = group_by(travel,COMID)
    final = summarize(final, t_shallow_mean_all = mean(t_shallow), t_shallow_med_all = median(t_shallow))
    
    add = group_by(travel2, COMID)
    add = summarize(add, t_shallow_mean_iso = mean(t_shallow), t_shallow_med_iso = median(t_shallow))
    
    final = merge(final, add, all=T)
    
    final$WSA_9 = master_table$WSA_9[match(final$COMID, master_table$COMID)]
  }
  if (i> 1){
    temp = group_by(travel,COMID)
    temp = summarize(temp, t_shallow_mean_all = mean(t_shallow), t_shallow_med_all = median(t_shallow))
    
    add = group_by(travel2, COMID)
    add = summarize(add, t_shallow_mean_iso = mean(t_shallow), t_shallow_med_iso = median(t_shallow))
    
    temp = merge(temp, add, all=T)
    
    temp$WSA_9 = master_table$WSA_9[match(temp$COMID, master_table$COMID)]
    final = rbind(final, temp)
  }
}
master_table$t_shallow_mean_all = final$t_shallow_mean_all[match(master_table$COMID, final$COMID)]
master_table$t_shallow_med_all = final$t_shallow_med_all[match(master_table$COMID, final$COMID)]
master_table$t_shallow_mean_iso = final$t_shallow_mean_iso[match(master_table$COMID, final$COMID)]
master_table$t_shallow_med_iso = final$t_shallow_med_iso[match(master_table$COMID, final$COMID)]


write.csv(master_table, paste0(cat_path, 'ShallowFlow.csv'), row.names=F)
rmNA = na.omit(master_table)
write.csv(rmNA, file = paste0(cat_path, 'ShallowFlow_narm.csv'), row.names=F)

# summary of wetland type by NHDPlus catchment
master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
for(i in 1:length(rpus)){
  print(rpus[i])
  wetlands = read.csv(paste0(wet_path, 'FlowClass_', rpus[i], '.csv'))
  summary(wetlands)
  #cat_lookup = read.csv(paste0(lookup_tables, 'Wetlands_NHDPlusCat_Lookup_', rpus[i], '.csv'))
  #wetlands$COMID = cat_lookup$COMID[match(wetlands$WET_ID, cat_lookup$WET_ID)]
  wetlands$Isolated = 0
  wetlands$Isolated[wetlands$Riparian != 100] = 1
  wetlands$Group2 = 1
  
  if (i==1){
    final = group_by(wetlands,COMID)
    final = summarize(final, sumG1 = sum(Isolated), sumG2 = sum(Group2))
    final$PCTGIW = (final$sumG1/final$sumG2) *100
    final$WSA_9 = master_table$WSA_9[match(final$COMID, master_table$COMID)]
    final = final[,c('COMID','PCTGIW','WSA_9')]
    print(summary(final))
  }
  if (i> 1){
    temp = group_by(wetlands,COMID)
    temp = summarize(temp, sumG1 = sum(Isolated), sumG2 = sum(Group2))
    temp$PCTGIW = (temp$sumG1/temp$sumG2) *100
    temp$WSA_9 = master_table$WSA_9[match(temp$COMID, master_table$COMID)]
    temp = temp[,c('COMID','PCTGIW','WSA_9')]
    print(summary(temp))
    final = rbind(final, temp)
  }
}  
master_table$PCTGIW = final$PCTGIW[match(master_table$COMID, final$COMID)]
#master_table$PCTGIW = round(master_table$PCTGIW)
write.csv(master_table, paste0(cat_path, 'GIW_PERCENT.csv'), row.names=F)
rmNA = na.omit(master_table)
write.csv(rmNA, file = paste0(cat_path, 'GIW_PERCENT_narm.csv'), row.names=F)



# # Mannings
# master_table = read.csv(paste0(lookup_tables,'eco9_all.csv'))
# for(i in 1:length(rpus)){
#   print(rpus[i])
#   travel = read.csv(paste0(accum_path, 'Mannings', rpus[i], '.csv'))
#   travel = travel[!is.na(travel$GeoMean), ]
#   wetid = read.csv(paste0(lookup_tables, 'WetlandsWithPath_StreamLink_Lookup_', rpus[i], '.csv'))
#   travel$WET_ID = wetid$WET_ID[match(travel$PATHID, wetid$STRMLNK_ID)]
#   cat_lookup = read.csv(paste0(lookup_tables, 'Wetlands_NHDPlusCat_Lookup_', rpus[i], '.csv'))
#   travel$COMID = cat_lookup$COMID[match(travel$WET_ID, cat_lookup$WET_ID)]
#   if (i==1){
#     final = group_by(travel,COMID)
#     final = summarize(final, GeoMean_mean = mean(GeoMean), GeoMean_med = median(GeoMean))
#     final$WSA_9 = master_table$WSA_9[match(final$COMID, master_table$COMID)]
#   }
#   if (i> 1){
#     temp = group_by(travel,COMID)
#     temp = summarize(temp, GeoMean_mean = mean(GeoMean), GeoMean_med = median(GeoMean))
#     temp$WSA_9 = master_table$WSA_9[match(temp$COMID, master_table$COMID)]
#     final = rbind(final, temp)
#   }
# }
# master_table$GeoMean_mean = final$GeoMean_mean[match(master_table$COMID, final$COMID)]
# master_table$GeoMean_med = final$GeoMean_med[match(master_table$COMID, final$COMID)]
# write.csv(master_table, paste0(cat_path, 'Mannings.csv'), row.names=F)

# Impervious
master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
for(i in 1:length(rpus)){
  print(rpus[i])
  intable = read.csv(paste0(wet_path, 'Impervious_', rpus[i], '.csv'))
  intable = intable[intable$Riparian != 100, ]
  print(summary(intable$BasinImperv))}
#   travel = travel[!is.na(travel$t_shallow), ]
#   cat_lookup = read.csv(paste0(lookup_tables, 'Wetlands_NHDPlusCat_Lookup_', rpus[i], '.csv'))
#   travel$COMID = cat_lookup$COMID[match(travel$WETID, cat_lookup$WET_ID)]
  if (i==1){
    final = group_by(intable,COMID)
    final = summarize(final, Impervious = mean(BasinImperv))

    final$WSA_9 = master_table$WSA_9[match(final$COMID, master_table$COMID)]
  }
  if (i> 1){
    temp = group_by(intable,COMID)
    temp = summarize(temp, Impervious = mean(BasinImperv))

    temp$WSA_9 = master_table$WSA_9[match(temp$COMID, master_table$COMID)]
    final = rbind(final, temp)
  }
}
master_table$Impervious = final$Impervious[match(master_table$COMID, final$COMID)]
write.csv(master_table, paste0(cat_path, 'PctImpervious.csv'), row.names=F)

# Levees
master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
for(i in 1:length(rpus)){
  print(rpus[i])
  intable = read.csv(paste0(wet_path, 'LeveeInfluence_', rpus[i], '.csv'))
  intable = intable[intable$Riparian != 100, ]
  intable$denom = 1
#   travel = travel[!is.na(travel$t_shallow), ]
#   cat_lookup = read.csv(paste0(lookup_tables, 'Wetlands_NHDPlusCat_Lookup_', rpus[i], '.csv'))
#   travel$COMID = cat_lookup$COMID[match(travel$WETID, cat_lookup$WET_ID)]
  if (i==1){
    final = group_by(intable,COMID)
    final = summarize(final, numer = sum(LeveeInfluence), denom = sum(denom))
    final$PctLevee = (final$numer / final$denom) * 100
    final$WSA_9 = master_table$WSA_9[match(final$COMID, master_table$COMID)]
    final = final[ , c('COMID','PctLevee','WSA_9')]
  }
  if (i> 1){
    temp = group_by(intable,COMID)
    temp = summarize(temp, numer = sum(LeveeInfluence), denom = sum(denom))
    temp$PctLevee = (temp$numer / temp$denom) * 100
    temp$WSA_9 = master_table$WSA_9[match(temp$COMID, master_table$COMID)]
    temp = temp[ , c('COMID','PctLevee','WSA_9')]
    final = rbind(final, temp)
  }
}
master_table$PctLevee = final$PctLevee[match(master_table$COMID, final$COMID)]
write.csv(master_table, paste0(cat_path, 'PctLeveeInfluence.csv'), row.names=F)

# Ag drainage (basin)
master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
for(i in 1:length(rpus)){
  print(rpus[i])
  intable = read.csv(paste0(wet_path, 'AgDrainage_Basin_', rpus[i], '.csv'))
  intable = intable[intable$Riparian != 100, ]
  print(summary(intable$PctAgDrainBasin))
#   travel = travel[!is.na(travel$t_shallow), ]
#   cat_lookup = read.csv(paste0(lookup_tables, 'Wetlands_NHDPlusCat_Lookup_', rpus[i], '.csv'))
#   travel$COMID = cat_lookup$COMID[match(travel$WETID, cat_lookup$WET_ID)]
  if (i==1){
    final = group_by(intable,COMID)
    final = summarize(final, PctAgDrainBasin = mean(PctAgDrainBasin))
  }
  if (i> 1){
    temp = group_by(intable,COMID)
    temp = summarize(temp, PctAgDrainBasin = mean(PctAgDrainBasin))
    final = rbind(final, temp)
  }
}
master_table$PctAgDrainBasin = final$PctAgDrainBasin[match(master_table$COMID, final$COMID)]
write.csv(master_table, paste0(cat_path, 'PctAgDrainBasin.csv'), row.names=F)

# Ag drainage (path)
master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
for(i in 1:length(rpus)){
  print(rpus[i])
  intable = read.csv(paste0(wet_path, 'AgDrainage_Path_', rpus[i], '.csv'))
  intable = intable[intable$Riparian != 100, ]
  print(summary(intable$PctAgDrainPath))
#   travel = travel[!is.na(travel$t_shallow), ]
#   cat_lookup = read.csv(paste0(lookup_tables, 'Wetlands_NHDPlusCat_Lookup_', rpus[i], '.csv'))
#   travel$COMID = cat_lookup$COMID[match(travel$WETID, cat_lookup$WET_ID)]
  if (i==1){
    final = group_by(intable,COMID)
    final = summarize(final, PctAgDrainPath = mean(PctAgDrainPath))
  }
  if (i> 1){
    temp = group_by(intable,COMID)
    temp = summarize(temp, PctAgDrainBasin = mean(PctAgDrainPath))
    final = rbind(final, temp)
  }
}
master_table$PctAgDrainPath = final$PctAgDrainPath[match(master_table$COMID, final$COMID)]
write.csv(master_table, paste0(cat_path, 'PctAgDrainPath.csv'), row.names=F)

# Wetland basin areas
master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
for(i in 1:length(rpus)){
  print(rpus[i])
  intable = read.csv(paste0(wet_path, 'WetBasinArea_', rpus[i], '.csv'))
  #intable = intable[intable$Riparian != 100, ]
  #print(summary(intable$PctAgDrainPath))
#   travel = travel[!is.na(travel$t_shallow), ]
#   cat_lookup = read.csv(paste0(lookup_tables, 'Wetlands_NHDPlusCat_Lookup_', rpus[i], '.csv'))
#   travel$COMID = cat_lookup$COMID[match(travel$WETID, cat_lookup$WET_ID)]
  if (i==1){
    final = group_by(intable,COMID)
    final = summarize(final, meanBasinArea = mean(AreaSqKm), totalBasinAreas = sum(AreaSqKm))
  }
  if (i> 1){
    temp = group_by(intable,COMID)
    temp = summarize(temp, meanBasinArea = mean(AreaSqKm), totalBasinAreas = sum(AreaSqKm))
    final = rbind(final, temp)
  }
}
master_table$meanBasinArea = final$meanBasinArea[match(master_table$COMID, final$COMID)]
master_table$totalBasinAreas = final$totalBasinAreas[match(master_table$COMID, final$COMID)]
write.csv(master_table, paste0(cat_path, 'WetBasinAreas.csv'), row.names=F)


```    

# Dominant flow class for catchments
```{r, eval=F}
accum_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/Accumulation/'

files = list.files(accum_path, pattern = 'NLCD'); rpus = c()
for(i in 1:length(files)){
  #print(files[i])
  rpus[i] = substr(files[i], 18, 20)
}

old_lookup = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/old_LookupTables/'
lookup_tables = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables_final/'
#master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
wet_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables_final/'
cat_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/NHDPlusCatchmentTables/'

master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
for(i in 1:length(rpus)){
  print(rpus[i])
  wetlands = read.csv(paste0(wet_path, 'FlowClass_', rpus[i], '.csv'))
  #print(summary(wetlands$DomFlow))}
  wetlands = wetlands[wetlands$DomFlow != 'Riparian', ]
  
  if (i==1){
    final = group_by(wetlands,COMID)
    levels(final$DomFlow)
    final = summarize(final, DomFlow = names(which.max(table(DomFlow))))
    #final$WSA_9 = master_table$WSA_9[match(final$COMID, master_table$COMID)]
    #final = final[,c('COMID','DomFlow','WSA_9')]
  }
  if (i> 1){
    temp = group_by(wetlands,COMID)
    levels(temp$DomFlow)
    temp = summarize(temp, DomFlow = names(which.max(table(DomFlow))))
    #temp$WSA_9 = master_table$WSA_9[match(temp$COMID, master_table$COMID)]
    #temp = temp[,c('COMID','DomFlow','WSA_9')]
    final = rbind(final, temp)
  }
}
levels(as.factor(final$DomFlow))
master_table$DomFlow_GIW = final$DomFlow[match(master_table$COMID, final$COMID)]
master_table$DomCode_GIW = NA
master_table$DomCode_GIW[master_table$DomFlow_GIW=='Overland'] = 1
master_table$DomCode_GIW[master_table$DomFlow_GIW=='Riparian'] = 2
master_table$DomCode_GIW[master_table$DomFlow_GIW=='Shallow'] = 3
master_table$DomCode_GIW[master_table$DomFlow_GIW=='ShallowDeep'] = 4
#names(master_table) = c('COMID','WSA_9','DomFlow_GIW','DomCode_GIW')
write.csv(master_table, paste0(cat_path, 'DOMFLOW_GIW.csv'), row.names=F)

```

# Dominant flow class for catchments (excluding riparian)
```{r, eval=F}
accum_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/Accumulation/'

files = list.files(accum_path, pattern = 'NLCD'); rpus = c()
for(i in 1:length(files)){
  #print(files[i])
  rpus[i] = substr(files[i], 18, 20)
}

old_lookup = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/old_LookupTables/'
lookup_tables = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables_final/'
#master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
wet_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables_final/'
cat_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/NHDPlusCatchmentTables/'

master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
for(i in 1:length(rpus)){
  print(rpus[i])
  wetlands = read.csv(paste0(wet_path, 'FlowClass_', rpus[i], '.csv'))
  #print(summary(wetlands$DomFlow))}
  
  if (i==1){
    final = group_by(wetlands,COMID)
    levels(final$DomFlow)
    final = summarize(final, DomFlow = names(which.max(table(DomFlow))))
    #final$WSA_9 = master_table$WSA_9[match(final$COMID, master_table$COMID)]
    #final = final[,c('COMID','DomFlow','WSA_9')]
  }
  if (i> 1){
    temp = group_by(wetlands,COMID)
    levels(temp$DomFlow)
    temp = summarize(temp, DomFlow = names(which.max(table(DomFlow))))
    #temp$WSA_9 = master_table$WSA_9[match(temp$COMID, master_table$COMID)]
    #temp = temp[,c('COMID','DomFlow','WSA_9')]
    final = rbind(final, temp)
  }
}
levels(as.factor(final$DomFlow))
master_table$DomFlow = final$DomFlow[match(master_table$COMID, final$COMID)]
master_table$DomCode = NA
master_table$DomCode[master_table$DomFlow=='Overland'] = 1
master_table$DomCode[master_table$DomFlow=='Riparian'] = 2

write.csv(master_table, paste0(cat_path, 'DOMFLOW.csv'), row.names=F)
#rmNA = na.omit(master_table)
#write.csv(rmNA, file = paste0(cat_path, 'DOMFLOW_narm.csv'), row.names=F)
```



# Dominant flood frequency for catchments
```{r, eval=F}
accum_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/Accumulation/'

files = list.files(accum_path, pattern = 'NLCD'); rpus = c()
for(i in 1:length(files)){
  #print(files[i])
  rpus[i] = substr(files[i], 18, 20)
}

old_lookup = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/old_LookupTables/'
lookup_tables = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables_final/'
master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
wet_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables_final/'
cat_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/NHDPlusCatchmentTables/'

master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
for(i in 1:length(rpus)){
  print(rpus[i])
  wetlands = read.csv(paste0(wet_path, 'DomFldFreqCls_', rpus[i], '.csv'))
  summary(wetlands)
  #wetlands$DomFldFreqCls = as.factor(wetlands$DomFldFreqCls)
  #levels(wetlands$DomFldFreqCls) = c("VALUE0","VALUE1","VALUE2","VALUE3")
  if (i==1){
    final = group_by(wetlands,COMID)
    levels(final$DomFldFreqCls)
    #final$DomFldFreqCls = as.character(final$DomFldFreqCls)
    final = summarize(final, DomFldFreqCls = names(which.max(table(DomFldFreqCls))))
    #final$WSA_9 = master_table$WSA_9[match(final$COMID, master_table$COMID)]
    #final = final[,c('COMID','DomFldFreqCls','WSA_9')]
  }
  if (i> 1){
    temp = group_by(wetlands,COMID)
    #levels(temp$DomFlow)
    temp = summarize(temp, DomFldFreqCls = names(which.max(table(DomFldFreqCls))))
    #temp$WSA_9 = master_table$WSA_9[match(temp$COMID, master_table$COMID)]
    #temp = temp[,c('COMID','DomFldFreqCls','WSA_9')]
    final = rbind(final, temp)
  }
}

master_table$DomFldFreqCls = final$DomFldFreqCls[match(master_table$COMID, final$COMID)]
levels(as.factor(master_table$DomFldFreqCls))
master_table$DomCode = NA
master_table$DomCode[master_table$DomFldFreqCls=='VALUE_0'] = 0
master_table$DomCode[master_table$DomFldFreqCls=='VALUE_1'] = 1
master_table$DomCode[master_table$DomFldFreqCls=='VALUE_2'] = 2
master_table$DomCode[master_table$DomFldFreqCls=='VALUE_3'] = 3
print(summary(master_table))
write.csv(master_table, paste0(cat_path, 'DomFldFreqCls.csv'), row.names=F)
rmNA = na.omit(master_table)
write.csv(rmNA, file = paste0(cat_path, 'DomFldFreqCls_narm.csv'), row.names=F)
```

# Dominant Drainage Class for catchments
```{r, eval=F}
accum_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/Accumulation/'

files = list.files(accum_path, pattern = 'NLCD'); rpus = c()
for(i in 1:length(files)){
  #print(files[i])
  rpus[i] = substr(files[i], 18, 20)
}

old_lookup = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/old_LookupTables/'
lookup_tables = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables_final/'
master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
wet_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables_final/'
cat_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/NHDPlusCatchmentTables/'

master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
for(i in 1:length(rpus)){
  print(rpus[i])
  wetlands = read.csv(paste0(wet_path, 'DrainClass_', rpus[i], '.csv'))
  head(wetlands)
  
  if (i==1){
    #wetlands$DomDrainClass = as.character(wetlands$DomDrainClass)
    final = group_by(wetlands,COMID)
    #levels(as.factor(final$DomDrainClass))
    final = summarize(final, DomDrainClass = names(which.max(table(DomDrainClass))))
    #final$WSA_9 = master_table$WSA_9[match(final$COMID, master_table$COMID)]
    #final = final[,c('COMID','DomDrainClass','WSA_9')]
  }
  if (i> 1){
    temp = group_by(wetlands,COMID)
    #levels(as.factor(temp$DomDrainClass))
    
    temp = summarize(temp, DomDrainClass = names(which.max(table(DomDrainClass))))
    #temp$WSA_9 = master_table$WSA_9[match(temp$COMID, master_table$COMID)]
    #temp = temp[,c('COMID','DomDrainClass','WSA_9')]
    final = rbind(final, temp)
  }
}

master_table$DomDrainClass = final$DomDrainClass[match(master_table$COMID, final$COMID)]
levels(as.factor(master_table$DomDrainClass))

master_table$DomCode = NA
master_table$DomCode[master_table$DomDrainClass=='VALUE_0'] = 0
master_table$DomCode[master_table$DomDrainClass=='VALUE_1'] = 1
master_table$DomCode[master_table$DomDrainClass=='VALUE_2'] = 2
master_table$DomCode[master_table$DomDrainClass=='VALUE_3'] = 3
print(summary(master_table))
write.csv(master_table, paste0(cat_path, 'DomDrainClass.csv'), row.names=F)
```


#Make Drain Class table
```{r, eval=F}
library(dplyr)
r = c('VALUE_0', 'VALUE_1', 'VALUE_2', 'VALUE_3')

for(i in 1:length(rpus)){
  
  print(rpus[i])
  flow_cls = read.csv(paste0(accum_path, 'DrainClass_PERCENT_', rpus[i], '.csv'))   
  missing <- r[is.na(match(r, names(flow_cls)))]
  flow_cls[,paste(missing)] <- c(0)
  
  flow_cls = flow_cls[, c('PathID', r)] #make in right order
  #print(summary(flow_cls))
  
  flow_cls[ ,2:5] = prop.table(as.matrix(flow_cls[ ,2:5]), margin = 1) * 100

  type_names = names(flow_cls)[2:5]  
  type_num = c(0,1,2,3)
  flow_cls = na.omit(flow_cls)  
  flow_cls$DomFlow = type_names[apply(flow_cls[, 2:5], 1, which.max)]
  flow_cls$DomCls = type_num[apply(flow_cls[, 2:5], 1, which.max)]
  print(summary(flow_cls))}
  write.csv(flow_cls, paste0(final_path, 'DrainClass_', rpus[i], '.csv'), row.names=F)



#Get wetland areas
```{r, eval=FALSE}
library(foreign)
wet_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables_final/'
wetland_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/AllWetlands_rpu/'
accum_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/Accumulation/'
final_lookup = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables_final/'
cat_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/NHDPlusCatchmentTables/'
master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
files = list.files(accum_path, pattern = 'NLCD'); rpus = c()
for(i in 1:length(files)){
  #print(files[i])
  rpus[i] = substr(files[i], 18, 20)
}

for(i in 1:length(rpus)){
  print(rpus[i])
  
  wetlands = read.dbf(paste0(wetland_path, 'Wetlands_', rpus[i], '.tif.vat.dbf'))
  allwet = read.csv(paste0(final_lookup, 'AllWetlands_StreamLink_Lookup_', rpus[i], '.csv'))
  flowclass = read.csv(paste0(wet_path, 'FlowClass_', rpus[i], '.csv'))
  
  names(wetlands) = toupper(names(wetlands))
  wetlands$AREA = (wetlands$COUNT * 900) / 1e6
  
  wetlands = wetlands[, c('VALUE', 'AREA')]
  names(wetlands) = c('WET_ID','WetlandArea')
  
  wetlands$COMID = allwet$COMID[match(wetlands$WET_ID, allwet$WET_ID)]
  wetlands$WSA_9 = allwet$WSA_9[match(wetlands$WET_ID, allwet$WET_ID)]
  wetlands$PATHID = allwet$STRMLNK_ID[match(wetlands$WET_ID, allwet$WET_ID)]
  wetlands$DomFlow = flowclass$DomFlow[match(wetlands$WET_ID, flowclass$WET_ID)]
    
  
  if(i == 1){
    outarea = wetlands
  }else{
    outarea = rbind(outarea, wetlands)
  }  
}

area_stats = group_by(outarea, COMID)
area_stats = summarize(area_stats, WetldArea_mean = mean(WetlandArea), WetldArea_sum = sum(WetlandArea))

master_table$WetldArea_mean = NA
master_table$WetldArea_sum = NA

master_table$WetldArea_mean = area_stats$WetldArea_mean[match(master_table$COMID, area_stats$COMID)]
master_table$WetldArea_sum = area_stats$WetldArea_sum[match(master_table$COMID, area_stats$COMID)]

write.csv(area_stats, file=paste0(cat_path, 'WetlandAreas.csv'))



for(i in 1:length(rpus)){
  print(rpus[i])

  allwet = read.csv(paste0(final_lookup, 'AllWetlands_StreamLink_Lookup_', rpus[i], '.csv'))
  
  if(i == 1){
    outwet = allwet
  }else{
    outwet = rbind(outwet, allwet)
  }  
}

outwet = outwet[, c('COMID','GRIDCODE')]

tmp = unique(outwet)

saveRDS(tmp, file = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/ForScott/comid_gridcode.rds')


```







