---
title: "Make WetPath Tables"
author: "Ryan Hill"
date: "Thursday, June 09, 2016"
output: html_document
---

# Set up
```{r, eval=F}
final_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables/'
accum_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/Accumulation/'
accum_cat = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandCat/Accumulation/'
precip_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/WetlandCat/Accumulation/'
data_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/WetlandPath/Data'
wetland_tables = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables/'
lookup_tables = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables/'
cat_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/NHDPlusCatchmentTables/'
#table_combo = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/CombiningTables/'
files = list.files(accum_path, pattern = 'NLCD'); rpus = c()
for(i in 1:length(files)){
  #print(files[i])
  rpus[i] = substr(files[i], 18, 20)
}
```

#Make rise, run, slope tables
```{r, eval=F}
for(i in 1:length(rpus)){
  print(rpus[i])
  elevmax = read.csv(paste0(accum_path, 'Elev_MAX_', rpus[i], '.csv'))
  elevmin = read.csv(paste0(accum_path, 'Elev_MIN_', rpus[i], '.csv'))  
  rise = merge(elevmax, elevmin)
  rise$rise = (rise$MAX - rise$MIN) / 100 #convert to meters
  rise$rise = rise$rise + 0.1
  rise = rise[ ,c('PathID', 'rise')]
  #names(rise) = c('PATHID', 'rise')
  write.csv(rise, paste0(accum_path, 'rise_m_', rpus[i], '.csv'), row.names=F)
}

# for(i in 1:length(rpus)){
#   print(rpus[i])
#   rise = read.csv(paste0(accum_path, 'rise_m_', rpus[i], '.csv'))
#   print(summary(rise))
#   #names(rise)[1] <- 'PATHID'
#   #write.csv(rise, paste0(accum_path, 'rise_m_', rpus[i], '.csv'), row.names=F)                
# }

#Make run tables

for(i in 1:length(rpus)){
  print(rpus[i])
  flmax = read.csv(paste0(accum_path, 'flowlength_m_MAX_', rpus[i], '.csv'))
  flmin = read.csv(paste0(accum_path, 'flowlength_m_MIN_', rpus[i], '.csv'))  
  run = merge(flmax, flmin)
  run$run = (run$MAX - run$MIN) + 15
  run = run[ ,c('PathID', 'run')]
  names(run) = c('PATHID', 'run')
  write.csv(run, paste0(accum_path, 'run_m_', rpus[i], '.csv'), row.names=F)
}


#Make slope tables

for(i in 1:length(rpus)){
  print(rpus[i])
  rise = read.csv(paste0(accum_path, 'rise_m_', rpus[i], '.csv'))
  run = read.csv(paste0(accum_path, 'run_m_', rpus[i], '.csv'))  
  slope = merge(rise, run)
  slope$slope = (slope$rise / slope$run) 
  slope = slope[ ,c('PATHID', 'slope')]
  write.csv(slope, paste0(accum_path, 'slope_', rpus[i], '.csv'), row.names=F)
}
```

#Make Precip and Mannings tables
```{r, eval=F}
library(stringr)
#path_dir = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/WetlandPath/Accumulation'
path_dir = accum_path

variables=list.files(path_dir)

# Mannings
library(foreign)
rat <- read.dbf('L:/Priv/CORFiles/Geospatial_Library/Data/Project/StreamCat/LandscapeRasters/QAComplete/nlcd2011.tif.vat.dbf')
names(rat) <- toupper(names(rat))
r <- sapply(rat$VALUE, function(x) paste(c('VALUE_',x),collapse=''))
library(matrixStats)
nlcdlist = variables[grep("NLCD2011", variables)]
mannings = read.csv('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/old_LookupTables/NLCD_Mannings_Lookup.csv')
head(mannings)
for (i in 1:length(nlcdlist)){
  nlcd = read.csv(paste0(path_dir,'/',nlcdlist[i]))
  head(nlcd)
  missing <- r[is.na(match(r, names(nlcd)))]
  nlcd[,paste(missing)] <- c(0)
  nlcd$Total <- rowSums(nlcd[,2:length(nlcd)])
  
  #calculate %s for each nlcd category
  for (k in 2:length(nlcd)){
    nlcd[,k] = 100.0 * nlcd[,k]/nlcd[,length(nlcd)]
  } 
  nlcd = nlcd[c(1:(length(nlcd)-1))]
  #calculate final mannings geometric mean
  #First raise each mannings to the % of flow path of NLCD type
  for (m in 2:length(nlcd)){
    nlcd[,m] = (mannings$Mannings[match(names(nlcd)[m], mannings$NLCD)])^(nlcd[,m])
  } 
  #Calculate geomean using product
  nlcd$GeoMean = (rowProds(as.matrix(nlcd[,2:17])))^(1/100)
  names(nlcd)[1] = 'PATHID'
  nlcd = nlcd[, c('PATHID','GeoMean')]
  write.csv(nlcd, paste0(path_dir, '/Mannings', str_sub(strsplit(nlcdlist[i],'\\.')[[1]][1],-3),'.csv'))
}

#New precip code
cat_dir = accum_cat
variables=list.files(cat_dir)
preciplist = variables[grep("US2yr24ha_mm_10x_MEAN_", variables)]
#lookups = list.files(lookup_tables)
#lookup_list = lookups[grep("WetlandsWithPath_StreamLink_Lookup", lookups)]
rpus = c()
for(i in 1:length(preciplist)){
  #print(files[i])
  rpus[i] = substr(preciplist[i], 23, 25)
}
for(i in 1:length(rpus)){
  precip = read.csv(paste0(cat_dir, 'US2yr24ha_mm_10x_MEAN_', rpus[i], '.csv'))
  precip$PRECIP_2YR24HR_MM = (precip$SUM / precip$COUNT) * 0.1
  lookup = read.csv(paste0(lookup_tables, 'WetlandsWithPath_StreamLink_Lookup_', rpus[i], '.csv'))
  names(precip) = toupper(names(precip))
  precip$PATHID = lookup$STRMLNK_ID[match(precip$BASINID, lookup$WET_ID)]
  precip = precip[, c('BASINID','PATHID','PRECIP_2YR24HR_MM')]
  write.csv(precip, paste0(accum_path, 'Precip2Yr24hr_', rpus[i], '.csv'), row.names=F)
}


#----------------------------------------------------------------------------------------------------------------------------------------------
#Old precip code that did no use accumulated precip
# Precip
library(foreign)
#cat_dir = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/WetlandCat/Zonal'
cat_dir = accum_cat
variables=list.files(cat_dir)
preciplist = variables[grep("US2yr24ha_mm_10x_MEAN_", variables)]
preciplist = preciplist[grep('\\.dbf$',preciplist)]
lookups = list.files('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/LookupTables')
lookup_list = lookups[grep("WetlandsWithPath_StreamLink_Lookup", lookups)]

for (i in 1:59){
  precip = read.dbf(paste0(cat_dir,'/',preciplist[i]))
  head(precip)
  precip$PRECIP_2YR24HR_MM = precip$MEAN * .1
  lookup = read.csv(paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/LookupTables/',lookup_list[i]))
  names(precip) = toupper(names(precip))
  precip$PATHID = lookup$STRMLNK_ID[match(precip$VALUE, lookup$WET_ID)]
  precip = precip[c(1,15,14)]
  names(precip)[1] = 'WETID'
  write.csv(precip, paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/WetlandCat/Accumulation/Precip2Yr24hr', str_sub(strsplit(preciplist[i],'\\.')[[1]][1],-3),'.csv'))
}

```


#Make combine to make start of shallow table
```{r, eval=F}
for(i in 1:length(rpus)){
  print(rpus[i])
  run = read.csv(paste0(accum_path, 'run_m_', rpus[i], '.csv'))
  slope = read.csv(paste0(accum_path, 'slope_', rpus[i], '.csv'))
  porosity = read.csv(paste0(accum_path, 'AvgPorosity_MAX_', rpus[i], '.csv'))
  names(porosity) <- c('PATHID', 'porosity_max')
  perm = read.csv(paste0(accum_path, 'AvgPerm_MIN_', rpus[i], '.csv'))
  perm$MIN = perm$MIN / 1000
  names(perm) <- c('PATHID', 'perm_min')
  
  out_table = run
  out_table = merge(out_table, slope)
  out_table = merge(out_table, porosity)
  out_table = merge(out_table, perm)
  
  write.csv(out_table, paste0(final_path, 'ShallowFlow_', rpus[i], '.csv'), row.names=F)
}
```

#Make shallow travel time
```{r, eval=F}
for(i in 1:length(rpus)){
  print(rpus[i])
  travel = read.csv(paste0(final_path, 'ShallowFlow_', rpus[i], '.csv'))
  
  print(summary(travel))}
  
  travel$perm_min = travel$perm_min #+ 0.1

  travel$slope = travel$slope + 0.01
  
  travel$t_shallow = travel$run / ((travel$perm_min / travel$porosity_max) * travel$slope)
  
  write.csv(travel, paste0(final_path, 'ShallowFlow_', rpus[i], '.csv'), row.names=F)
}
```

#Make flow type table
```{r, eval=F}
library(dplyr)
r = c('VALUE_11', 'VALUE_12', 'VALUE_21', 'VALUE_22')

for(i in 1:length(rpus)){
  
  print(rpus[i])
  flow_cls = read.csv(paste0(accum_path, 'BdrckPerm_4_classes_Alb83_PERCENT_', rpus[i], '.csv'))   
  missing <- r[is.na(match(r, names(flow_cls)))]
  flow_cls[,paste(missing)] <- c(0)
  
  flow_cls = flow_cls[, c('PathID', r)] #make in right order
  
  flow_cls[ ,2:5] = prop.table(as.matrix(flow_cls[ ,2:5]), margin = 1) * 100
  flow_cls$Overland = flow_cls$VALUE_11 + flow_cls$VALUE_21
  flow_cls = select(flow_cls, -VALUE_11, -VALUE_21)
    #Make sure in correct order
  flow_cls = flow_cls[, c('PathID','VALUE_12','VALUE_22','Overland')]  
  names(flow_cls)[1:3] <- c('PATHID','Shallow','ShallowDeep')
  type_names = names(flow_cls)[2:4]  
  flow_cls = na.omit(flow_cls)  
  flow_cls$DomFlow = type_names[apply(flow_cls[, 2:4], 1, which.max)]
  write.csv(flow_cls, paste0(final_path, 'FlowClass_', rpus[i], '.csv'), row.names=F)
  
}     
        
        
```

#Make flood freq table
```{r, eval=F}
library(dplyr)
r = c('VALUE_0', 'VALUE_1', 'VALUE_2', 'VALUE_3')

for(i in 1:length(rpus)){
  
  print(rpus[i])
  flow_cls = read.csv(paste0(accum_cat, 'FloodFreq_PERCENT_', rpus[i], '.csv'))   
  missing <- r[is.na(match(r, names(flow_cls)))]
  flow_cls[,paste(missing)] <- c(0)
  
  flow_cls = flow_cls[, c('BasinID', r)] #make in right order
  
  flow_cls[ ,2:5] = prop.table(as.matrix(flow_cls[ ,2:5]), margin = 1) * 100
  #flow_cls$Overland = flow_cls$VALUE_11 + flow_cls$VALUE_21
  #flow_cls = select(flow_cls, -VALUE_11, -VALUE_21)
    #Make sure in correct order
  #flow_cls = flow_cls[, c('PathID','VALUE_12','VALUE_22','Overland')]  
  #names(flow_cls)[1:3] <- c('PATHID','Shallow','ShallowDeep')
  type_names = names(flow_cls)[2:5]  
  flow_cls = na.omit(flow_cls)  
  flow_cls$DomFldFreqCls = type_names[apply(flow_cls[, 2:5], 1, which.max)]
  write.csv(flow_cls, paste0(final_path, 'FloodFreq_', rpus[i], '.csv'), row.names=F)  
}     
        
        
```

#Make Drain Class table
```{r, eval=F}
library(dplyr)
r = c('VALUE_0', 'VALUE_1', 'VALUE_2', 'VALUE_3')

for(i in 1:length(rpus)){
  
  print(rpus[i])
  flow_cls = read.csv(paste0(accum_path, 'DrainClass_PERCENT_', rpus[i], '.csv'))   
  missing <- r[is.na(match(r, names(flow_cls)))]
  flow_cls[,paste(missing)] <- c(0)
  
  flow_cls = flow_cls[, c('PathID', r)] #make in right order
  #print(summary(flow_cls))
  
  flow_cls[ ,2:5] = prop.table(as.matrix(flow_cls[ ,2:5]), margin = 1) * 100
 
  type_names = names(flow_cls)[2:5]  
  type_num = c(0,1,2,3)
  flow_cls = na.omit(flow_cls)  
  flow_cls$DomFlow = type_names[apply(flow_cls[, 2:5], 1, which.max)]
  #flow_cls$DomCls = type_num[apply(flow_cls[, 2:5], 1, which.max)]
  print(head(flow_cls))
  write.csv(flow_cls, paste0(final_path, 'DrainClass_', rpus[i], '.csv'), row.names=F)
  
}     
        
        
```











#Make combine to make start of overland table
```{r, eval=F}
for(i in 1:length(rpus)){
  print(rpus[i])
  run = read.csv(paste0(accum_path, 'run_m_', rpus[i], '.csv'))
  slope = read.csv(paste0(accum_path, 'slope_', rpus[i], '.csv'))
  slope$slope = slope$slope + 0.01
  man = read.csv(paste0(accum_path, 'Mannings', rpus[i], '.csv'))
  man = man[ , c('PATHID','GeoMean')]
  names(man) <- c('PATHID','Manning')
  precip = read.csv(paste0(accum_path, 'Precip2Yr24hr_', rpus[i], '.csv'))
  precip = precip[!is.na(precip$PATHID),]
  # precip 2yr24hr values already divided by 10 when making accumulation tables, so use as is
  #precip = precip[c(2:4)]
  out_table = precip
  out_table = merge(out_table, slope, by='PATHID', all.x=TRUE)
  out_table = merge(out_table, man, by='PATHID', all.x=TRUE)
  out_table = merge(out_table, run, by='PATHID', all.x=TRUE)
  write.csv(out_table, paste0(final_path, 'OverlandFlow_', rpus[i], '.csv'), row.names=F)
}

```

#Make overland travel time
```{r, eval=F}
for(i in 1:length(rpus)){
  print(rpus[i])
  travel = read.csv(paste0(final_path, 'OverlandFlow_', rpus[i], '.csv'))
  
  travel$t_overland = 0.0913*(((travel$Manning * travel$run)^0.8)/((travel$PRECIP_2YR24HR_MM)^0.5 * (travel$slope)^0.4))
  
  write.csv(travel, paste0(final_path, 'OverlandFlow_', rpus[i], '.csv'), row.names=F)
}
```

#Get  flow type for wetlands with no path 
```{r, eval=F}
library(raster)
library(dplyr)
r = c('VALUE_11', 'VALUE_12', 'VALUE_21', 'VALUE_22')

bdrck = raster('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Gleason/BdrckPerm_4_classes_Alb83.tif')
  
for(i in 1:length(rpus)){
  print(rpus[i])
  wet_points = readOGR(data_path, paste0('WetlandPoints', rpus[i])) 
  projection(bdrck)
  proj4string(wet_points)
  results = extract(bdrck, wet_points)
  wet_points$DomFlow =  results
  wet_points$DomFlow[wet_points$DomFlow %in% c(11,21)] = 'Overland'
  wet_points$DomFlow[wet_points$DomFlow == 12] = 'Shallow'
  wet_points$DomFlow[wet_points$DomFlow == 22] = 'ShallowDeep'
  wet_points = wet_points[,c('GRID_CODE','DomFlow')]
  names(wet_points)[1] = 'WETID'
  write.csv(wet_points, paste0(wetland_tables, 'Wetland_NoPath_FlowClass', rpus[i], '.csv'), row.names=F)
}     

for(i in 1:length(rpus)){
  print(rpus[i])
  wet_points = read.csv(paste0(wetland_tables, 'Wetland_NoPath_FlowClass', rpus[i], '.csv')) 
  wet_points = wet_points[,c('GRID_CODE','DomFlow')]
  names(wet_points)[1] = 'WETID'
  write.csv(wet_points, paste0(wetland_tables, 'Wetland_NoPath_FlowClass', rpus[i], '.csv'), row.names=F)
}     
```

#Make levee influence tables
```{r, eval=F}
for(i in 1:length(rpus)){
  print(rpus[i])
  levee = read.csv(paste0(accum_path, 'LeveeProximity_PERCENT_', rpus[i], '.csv'))  
  if(ncol(levee) == 1){
    levee$VALUE_1 = 0
  }   
  levee$LeveeInfluence = 0
  levee$LeveeInfluence[levee$VALUE_1 > 0] = 1
  levee = levee[, c('PathID','LeveeInfluence')]
  names(levee)[1] = 'PATHID'
  write.csv(levee, paste0(final_path, 'LeveeInfluence_', rpus[i], '.csv'), row.names=F)
  
}
```

#Make wetland basin imperviousness tables (isolated wetlands)
```{r, eval=F}
for(i in 1:length(rpus)){
  print(rpus[i])
  imperv = read.csv(paste0(accum_cat, 'Impervious_2011_MEAN_', rpus[i], '.csv'))  
  
  imperv$BasinImperv = imperv$SUM / imperv$COUNT
  names(imperv)[1] = 'BASINID'
  imperv = imperv[ , c('BASINID','BasinImperv')]  
  
  write.csv(imperv, paste0(final_path, 'Imperviousness_', rpus[i], '.csv'), row.names=F)
  
}
```

#Make wetland basin ag drainage tables (isolated wetlands)
```{r, eval=F}

r = c('VALUE_0', 'VALUE_1')

for(i in 1:length(rpus)){
  print(rpus[i])
  ad = read.csv(paste0(accum_cat, 'AgDrainage_PERCENT_', rpus[i], '.csv'))  
  missing <- r[is.na(match(r, names(ad)))]
  ad[,paste(missing)] <- c(0)
  ad[ ,2:3] = prop.table(as.matrix(ad[ ,2:3]), margin = 1) * 100
  ad = ad[, c('BasinID','VALUE_1')]
  names(ad) = c('BASINID','PctAgDrainBasin')
 
  write.csv(ad, paste0(final_path, 'AgDrainage_Basin_', rpus[i], '.csv'), row.names=F)
  
}
```

#Make wetland flowpath ag drainage tables (isolated wetlands)
```{r, eval=F}

r = c('VALUE_0', 'VALUE_1')

for(i in 1:length(rpus)){
  print(rpus[i])
  ad = read.csv(paste0(accum_path, 'AgDrain_PERCENT_', rpus[i], '.csv'))  
  missing <- r[is.na(match(r, names(ad)))]
  ad[,paste(missing)] <- c(0)
  ad[ ,2:3] = prop.table(as.matrix(ad[ ,2:3]), margin = 1) * 100
  ad = ad[, c('PathID','VALUE_1')]
  names(ad) = c('PATHID','PctAgDrainPath')
 
  write.csv(ad, paste0(final_path, 'AgDrainage_Path_', rpus[i], '.csv'), row.names=F)
  
}
```

#Make basin area tables (isolated wetlands)
```{r, eval=F}
for(i in 1:length(rpus)){
  print(rpus[i])
  precip = read.csv(paste0(cat_dir, 'US2yr24ha_mm_10x_MEAN_', rpus[i], '.csv'))
  precip$AreaSqKm = (precip$COUNT * 900) / 1e6
  precip = precip[, c('BasinID','AreaSqKm')]
  names(precip)[1] = 'BASINID'
  write.csv(precip, paste0(final_path, 'BasinAreaSqKm_', rpus[i], '.csv'), row.names=F)
}
```


#Tag COMID to GRIDCODE for wetlands
```{r, eval=F}
library(foreign)
centroid_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/AllWetlands_centroids/'
nhd_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/RESOURCE/PHYSICAL/HYDROLOGY/NHDPlusV21'
lookup_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables/'
rpu_lookup_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables/'
out_lookup = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables_final/'
rpu_vpu = read.csv(paste0(centroid_path, 'rpu_vpu.csv'))


hydro.rgns <- c("01","02","03S","03N","03W","04","05","06","07","08","09","10L","10U","11","12","13","14","15","16","17","18")
rgns <- c("NE","MA","SA","SA","SA","GL","MS","MS","MS","MS","SR","MS","MS","MS","TX","RG","CO","CO","GB","PN","CA")
for (i in 1:21){
  print(hydro.rgns[i])
    #Read in catchment DBF
  CatID_GC = read.dbf(paste0(nhd_path,"/NHDPlus",rgns[i],"/NHDPlus",hydro.rgns[i],"/NHDPlusCatchment/Catchment.dbf"))
  head(CatID_GC)
  CatID_GC = CatID_GC[, c('GRIDCODE','FEATUREID')]
  #names(CatID_GC) = c('GRIDCODE','COMID')
    #Read in centroids tagged with GRIDCODE (at first called RASTERVALU)
  wetID_GC = read.dbf(paste0(centroid_path, 'wetlands_catID_', hydro.rgns[i], '.dbf'))
  
  print(head(wetID_GC))
  wetID_GC = wetID_GC[, c('GRIDCODE', 'RASTERVALU')]
  names(wetID_GC) = c('WET_ID', 'GRIDCODE')
    #Merge to get WET_ID/COMID assoc.
  wetID_COMID = merge(wetID_GC, CatID_GC)
  names(wetID_COMID) = c('GRIDCODE','WET_ID','COMID')
  print(summary(wetID_COMID))
  write.csv(wetID_COMID, paste0(centroid_path, 'WETID_COMID_Lookup', hydro.rgns[i], '.csv'), row.names=F)
  
}
  


for(k in 1:nrow(rpu_vpu)){
  rpu = rpu_vpu[k, 2]
  vpu = rpu_vpu[k, 3]
  
  print(rpu)
  print(vpu)
  
  wetid_comid = read.csv(paste0(centroid_path, 'WETID_COMID_Lookup', vpu, '.csv'))
  wetid_comid = wetid_comid[!duplicated(wetid_comid$WET_ID), ]
  
  allwet = read.csv(paste0(rpu_lookup_path, 'AllWetlands_StreamLink_Lookup_', rpu, '.csv'))
  allwet = merge(allwet, wetid_comid, by='WET_ID')
  print(nrow(allwet))
  write.csv(allwet, paste0(out_lookup, 'AllWetlands_StreamLink_Lookup_', rpu, '.csv'), row.names=F)

  isowet = read.csv(paste0(rpu_lookup_path, 'WetlandsWithPath_StreamLink_Lookup_', rpu, '.csv'))
  isowet = merge(isowet, wetid_comid, by='WET_ID')
  write.csv(isowet, paste0(out_lookup, 'WetlandsWithPath_StreamLink_Lookup_', rpu, '.csv'), row.names=F)
  
  xwet = read.csv(paste0(rpu_lookup_path, 'WetlandsNoPath_StreamLink_Lookup_', rpu, '.csv'))
  names(xwet) = c('X','WET_ID')
  xwet = merge(xwet, wetid_comid, by='WET_ID')
  write.csv(xwet, paste0(out_lookup, 'WetlandsNoPath_StreamLink_Lookup_', rpu, '.csv'), row.names=F)  
}

```


#Add ecoregion to final lookup tables
```{r, eval=F}
centroid_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/AllWetlands_centroids/'
rpu_vpu = read.csv(paste0(centroid_path, 'rpu_vpu.csv'))
old_lookup = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/old_LookupTables/'
final_lookup = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables_final/'

eco9 = read.csv(paste0(old_lookup, 'eco9_all.csv'))

for(k in 1:nrow(rpu_vpu)){
  rpu = rpu_vpu[k, 2]
  
  print(rpu)
  
  allwet = read.csv(paste0(final_lookup, 'AllWetlands_StreamLink_Lookup_', rpu, '.csv'))
  allwet = merge(allwet, eco9, by='COMID')
  print(nrow(allwet))
  write.csv(allwet, paste0(out_lookup, 'AllWetlands_StreamLink_Lookup_', rpu, '.csv'), row.names=F)

  isowet = read.csv(paste0(final_lookup, 'WetlandsWithPath_StreamLink_Lookup_', rpu, '.csv'))
  isowet = merge(isowet, eco9, by='COMID')
  write.csv(isowet, paste0(out_lookup, 'WetlandsWithPath_StreamLink_Lookup_', rpu, '.csv'), row.names=F)
  
  xwet = read.csv(paste0(final_lookup, 'WetlandsNoPath_StreamLink_Lookup_', rpu, '.csv'))
  xwet = merge(xwet, eco9, by='COMID')
  write.csv(xwet, paste0(out_lookup, 'WetlandsNoPath_StreamLink_Lookup_', rpu, '.csv'), row.names=F)  
}

```


#Add COMID and eco9 to tables
FlowType
```{r}
accum_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/Accumulation/'
table_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables/'
out_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables_final/'
final_lookup = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables_final/'

files = list.files(accum_path, pattern = 'NLCD'); rpus = c()
for(i in 1:length(files)){
  #print(files[i])
  rpus[i] = substr(files[i], 18, 20)
}

for(i in 1:length(rpus)){
  print(rpus[i])
  
  in_table = read.csv(paste0(table_path, 'FlowClass_', rpus[i], '.csv'))
  
  ######################
  #We seem to have more records for flow class than isolated wetlands - why????
  nrow(in_table)
  head(in_table)
  allwet = read.csv(paste0(final_lookup, 'AllWetlands_StreamLink_Lookup_', rpus[i], '.csv'))
  head(allwet)
  in_table = merge(in_table, allwet, by.x='PATHID', by.y='STRMLNK_ID')  
  in_table$Riparian = 0
  in_table = in_table[ , c('PATHID','WET_ID','COMID','WSA_9', 'Shallow', 'ShallowDeep', 'Overland', 'Riparian', 'DomFlow')]
  summary(in_table)
  xwet = read.csv(paste0(final_lookup, 'WetlandsNoPath_StreamLink_Lookup_', rpus[i], '.csv'))
  xwet$PATHID = NA; xwet$Shallow = 0; xwet$ShallowDeep = 0; xwet$Overland = 0; xwet$Riparian = 100; xwet$DomFlow = 'Riparian'
  xwet = xwet[ , c('PATHID','WET_ID','COMID','WSA_9', 'Shallow', 'ShallowDeep', 'Overland', 'Riparian', 'DomFlow')]
  in_table = rbind(in_table, xwet)
  print(summary(in_table))
  write.csv(in_table, paste0(out_path, 'FlowClass_', rpus[i], '.csv'), row.names=F)
  
}
```

#Add COMID and eco9 to tables
Overland Flow
```{r}
accum_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/Accumulation/'
table_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables/'
out_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables_final/'
final_lookup = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables_final/'

files = list.files(accum_path, pattern = 'NLCD'); rpus = c()
for(i in 1:length(files)){
  #print(files[i])
  rpus[i] = substr(files[i], 18, 20)
}

for(i in 1:length(rpus)){
  print(rpus[i])
  
  in_table = read.csv(paste0(table_path, 'OverlandFlow_', rpus[i], '.csv'))

  nrow(in_table)
  head(in_table)
  allwet = read.csv(paste0(final_lookup, 'AllWetlands_StreamLink_Lookup_', rpus[i], '.csv'))
  head(allwet)

  in_table = merge(in_table, allwet, by.x='PATHID', by.y='STRMLNK_ID')  
  
  head(in_table)
  names(in_table)
  in_table = in_table[c(1:8,12)]
  names(in_table)[2] = 'WET_ID'
  in_table$Riparian = 0
  in_table = in_table[ , c('PATHID','WET_ID','COMID','WSA_9', 'PRECIP_2YR24HR_MM', 'slope', 'Manning', 'Riparian','run', 't_overland')]
  xwet = read.csv(paste0(final_lookup, 'WetlandsNoPath_StreamLink_Lookup_', rpus[i], '.csv'))
  xwet$PATHID = NA; xwet$PRECIP_2YR24HR_MM = 0; xwet$slope = 0; xwet$Manning = 0; xwet$Riparian = 100; xwet$run = 0; xwet$t_overland = 0
  xwet = xwet[ , c('PATHID','WET_ID','COMID','WSA_9', 'PRECIP_2YR24HR_MM', 'slope', 'Manning', 'Riparian', 'run', 't_overland')]
  in_table = rbind(in_table, xwet)
  write.csv(in_table, paste0(out_path, 'OverlandFlow_', rpus[i], '.csv'), row.names=F)
  }
```

#Add COMID and eco9 to tables
Subsurface Flow
```{r}
accum_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/Accumulation/'
table_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables/'
out_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables_final/'
final_lookup = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables_final/'

files = list.files(accum_path, pattern = 'NLCD'); rpus = c()
for(i in 1:length(files)){
  #print(files[i])
  rpus[i] = substr(files[i], 18, 20)
}

for(i in 1:length(rpus)){
  print(rpus[i])
  
  in_table = read.csv(paste0(table_path, 'ShallowFlow_', rpus[i], '.csv'))

  nrow(in_table)
  head(in_table)
  allwet = read.csv(paste0(final_lookup, 'AllWetlands_StreamLink_Lookup_', rpus[i], '.csv'))
  head(allwet)

  in_table = merge(in_table, allwet, by.x='PATHID', by.y='STRMLNK_ID')  
  
  head(in_table)
  names(in_table)
  in_table = in_table[c(1:8,11)]
  in_table$Riparian = 0
  in_table = in_table[ , c('PATHID','WET_ID','COMID','WSA_9', 'run', 'slope', 'porosity_max', 'Riparian','perm_min', 't_shallow')]
  xwet = read.csv(paste0(final_lookup, 'WetlandsNoPath_StreamLink_Lookup_', rpus[i], '.csv'))
  xwet$PATHID = NA; xwet$run = 0; xwet$slope = 0; xwet$porosity_max = 0; xwet$Riparian = 100; xwet$perm_min = 0; xwet$t_shallow = 0
  xwet = xwet[ , c('PATHID','WET_ID','COMID','WSA_9', 'run', 'slope', 'porosity_max', 'Riparian','perm_min', 't_shallow')]
  in_table = rbind(in_table, xwet)
  write.csv(in_table, paste0(out_path, 'ShallowFlow_', rpus[i], '.csv'), row.names=F)
  }
```

#Add COMID and eco9 to tables
Imperviousness
```{r}
accum_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/Accumulation/'
table_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables/'
out_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables_final/'
final_lookup = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables_final/'

files = list.files(accum_path, pattern = 'NLCD'); rpus = c()
for(i in 1:length(files)){
  #print(files[i])
  rpus[i] = substr(files[i], 18, 20)
}

for(i in 1:length(rpus)){
  print(rpus[i])
  
  in_table = read.csv(paste0(table_path, 'Imperviousness_', rpus[i], '.csv'))

  nrow(in_table)
  head(in_table)
  allwet = read.csv(paste0(final_lookup, 'AllWetlands_StreamLink_Lookup_', rpus[i], '.csv'))
  head(allwet)

  in_table = merge(in_table, allwet, by.x='BASINID', by.y='WET_ID')  
  
  head(in_table)
  names(in_table)
  in_table = in_table[c(1:3,5,7)]
  in_table$Riparian = 0
  names(in_table)[1] = 'WET_ID'
  names(in_table)[4] = 'PATHID'
  in_table = in_table[ , c('WET_ID','PATHID','COMID','WSA_9', 'Riparian','BasinImperv')]
  xwet = read.csv(paste0(final_lookup, 'WetlandsNoPath_StreamLink_Lookup_', rpus[i], '.csv'))
  xwet$PATHID = NA; xwet$BasinImperv = 0; xwet$Riparian = 100
  xwet = xwet[c(1:2,5:8)]
  xwet = xwet[ ,  c('WET_ID','PATHID','COMID','WSA_9', 'Riparian','BasinImperv')]
  in_table = rbind(in_table, xwet)
  write.csv(in_table, paste0(out_path, 'Impervious_', rpus[i], '.csv'), row.names=F)
  }
```

#Add COMID and eco9 to tables
Ag Drainage Basin
```{r}
accum_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/Accumulation/'
table_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables/'
out_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables_final/'
final_lookup = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables_final/'

files = list.files(accum_path, pattern = 'NLCD'); rpus = c()
for(i in 1:length(files)){
  #print(files[i])
  rpus[i] = substr(files[i], 18, 20)
}

for(i in 1:length(rpus)){
  print(rpus[i])
  
  in_table = read.csv(paste0(table_path, 'AgDrainage_Basin_', rpus[i], '.csv'))

  nrow(in_table)
  head(in_table)
  allwet = read.csv(paste0(final_lookup, 'AllWetlands_StreamLink_Lookup_', rpus[i], '.csv'))
  head(allwet)

  in_table = merge(in_table, allwet, by.x='BASINID', by.y='WET_ID')  
  
  head(in_table)
  names(in_table)
  in_table = in_table[c(1:3,5,7)]
  in_table$Riparian = 0
  names(in_table)[1] = 'WET_ID'
  names(in_table)[4] = 'PATHID'
  in_table = in_table[ , c('WET_ID','PATHID','COMID','WSA_9', 'Riparian','PctAgDrainBasin')]
  xwet = read.csv(paste0(final_lookup, 'WetlandsNoPath_StreamLink_Lookup_', rpus[i], '.csv'))
  xwet$PATHID = NA; xwet$PctAgDrainBasin = 0; xwet$Riparian = 100
  xwet = xwet[c(1:2,5:8)]
  xwet = xwet[ ,  c('WET_ID','PATHID','COMID','WSA_9', 'Riparian','PctAgDrainBasin')]
  in_table = rbind(in_table, xwet)
  write.csv(in_table, paste0(out_path, 'AgDrainage_Basin_', rpus[i], '.csv'), row.names=F)
  }
```

#Add COMID and eco9 to tables
Ag Drainage Path
```{r}
accum_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/Accumulation/'
table_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables/'
out_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables_final/'
final_lookup = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables_final/'

files = list.files(accum_path, pattern = 'NLCD'); rpus = c()
for(i in 1:length(files)){
  #print(files[i])
  rpus[i] = substr(files[i], 18, 20)
}

for(i in 1:length(rpus)){
  print(rpus[i])
  
  in_table = read.csv(paste0(table_path, 'AgDrainage_Path_', rpus[i], '.csv'))

  nrow(in_table)
  head(in_table)
  allwet = read.csv(paste0(final_lookup, 'AllWetlands_StreamLink_Lookup_', rpus[i], '.csv'))
  head(allwet)

  in_table = merge(in_table, allwet, by.x='PATHID', by.y='STRMLNK_ID')  
  
  head(in_table)
  names(in_table)
  in_table = in_table[c(1:4,7)]
  in_table$Riparian = 0
  in_table = in_table[ , c('WET_ID','PATHID','COMID','WSA_9', 'Riparian','PctAgDrainPath')]
  xwet = read.csv(paste0(final_lookup, 'WetlandsNoPath_StreamLink_Lookup_', rpus[i], '.csv'))
  xwet$PATHID = NA; xwet$PctAgDrainPath = 0; xwet$Riparian = 100
  xwet = xwet[c(1:2,5:8)]
  xwet = xwet[ ,  c('WET_ID','PATHID','COMID','WSA_9', 'Riparian','PctAgDrainPath')]
  in_table = rbind(in_table, xwet)
  write.csv(in_table, paste0(out_path, 'AgDrainage_Path_', rpus[i], '.csv'), row.names=F)
  }
```

#Add COMID and eco9 to tables
FloodFreq Basin
```{r}
accum_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/Accumulation/'
table_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables/'
out_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables_final/'
final_lookup = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables_final/'

files = list.files(accum_path, pattern = 'NLCD'); rpus = c()
for(i in 1:length(files)){
  #print(files[i])
  rpus[i] = substr(files[i], 18, 20)
}

for(i in 1:length(rpus)){
  print(rpus[i])
  
  in_table = read.csv(paste0(table_path, 'FloodFreq_', rpus[i], '.csv'))

  nrow(in_table)
  head(in_table)
  allwet = read.csv(paste0(final_lookup, 'AllWetlands_StreamLink_Lookup_', rpus[i], '.csv'))
  head(allwet)

  in_table = merge(in_table, allwet, by.x='BasinID', by.y='WET_ID')  
  
  head(in_table)
  names(in_table)
  in_table = in_table[c(1,6:7,9,11)]
  #in_table$Riparian = 0
  names(in_table)[1] = 'WET_ID'
  names(in_table)[4] = 'PATHID'
  in_table = in_table[ , c('WET_ID','PATHID','COMID','WSA_9', 'DomFldFreqCls')]
  #levels(in_table$DomFldFreqCls) = c(0,1,2,3)
  #xwet = read.csv(paste0(final_lookup, 'WetlandsNoPath_StreamLink_Lookup_', rpus[i], '.csv'))
  #xwet$PATHID = NA; xwet$DomFldFreqCls = 0; xwet$Riparian = 100
  #xwet = xwet[c(1:2,5:8)]
  #xwet = xwet[ ,  c('WET_ID','PATHID','COMID','WSA_9', 'Riparian','DomFldFreqCls')]
  #in_table = rbind(in_table, xwet)
  write.csv(in_table, paste0(out_path, 'DomFldFreqCls_', rpus[i], '.csv'), row.names=F)
  }
```

#Add COMID and eco9 to tables
DrainClass Path
```{r}
accum_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/Accumulation/'
table_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables/'
out_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables_final/'
final_lookup = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables_final/'

files = list.files(accum_path, pattern = 'NLCD'); rpus = c()
for(i in 1:length(files)){
  #print(files[i])
  rpus[i] = substr(files[i], 18, 20)
}

for(i in 1:length(rpus)){
  print(rpus[i])
  
  in_table = read.csv(paste0(table_path, 'DrainClass_', rpus[i], '.csv'))

  nrow(in_table)
  head(in_table)
  allwet = read.csv(paste0(final_lookup, 'AllWetlands_StreamLink_Lookup_', rpus[i], '.csv'))
  head(allwet)

  in_table = merge(in_table, allwet, by.x='PathID', by.y='STRMLNK_ID')  
  
  head(in_table)
  names(in_table)
  in_table = in_table[c(1,7:9,12)]
  #in_table$Riparian = 0
  names(in_table)[1] = 'PATHID'
  names(in_table)[2] = 'DomDrainClass'
  in_table = in_table[ , c('WET_ID','PATHID','COMID','WSA_9', 'Riparian','DomDrainClass')]
  #xwet = read.csv(paste0(final_lookup, 'WetlandsNoPath_StreamLink_Lookup_', rpus[i], '.csv'))
  #xwet$PATHID = NA; xwet$DomDrainClass = 0; xwet$Riparian = 100
  #xwet = xwet[c(1:2,5:8)]
  #xwet = xwet[ ,  c('WET_ID','PATHID','COMID','WSA_9', 'Riparian','DomDrainClass')]
  #in_table = rbind(in_table, xwet)
  write.csv(in_table, paste0(out_path, 'DrainClass_', rpus[i], '.csv'), row.names=F)
  }
```

#Add COMID and eco9 to tables
LeveeInfluence
```{r}
accum_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/Accumulation/'
table_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables/'
out_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables_final/'
final_lookup = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables_final/'

files = list.files(accum_path, pattern = 'NLCD'); rpus = c()
for(i in 1:length(files)){
  #print(files[i])
  rpus[i] = substr(files[i], 18, 20)
}

for(i in 1:length(rpus)){
  print(rpus[i])
  
  in_table = read.csv(paste0(table_path, 'LeveeInfluence_', rpus[i], '.csv'))

  nrow(in_table)
  head(in_table)
  allwet = read.csv(paste0(final_lookup, 'AllWetlands_StreamLink_Lookup_', rpus[i], '.csv'))
  head(allwet)

  in_table = merge(in_table, allwet, by.x='PATHID', by.y='STRMLNK_ID')  
  
  head(in_table)
  names(in_table)
  in_table = in_table[c(1:4,7)]
  in_table$Riparian = 0
  in_table = in_table[ , c('WET_ID','PATHID','COMID','WSA_9', 'Riparian','LeveeInfluence')]
  xwet = read.csv(paste0(final_lookup, 'WetlandsNoPath_StreamLink_Lookup_', rpus[i], '.csv'))
  xwet$PATHID = NA; xwet$LeveeInfluence = 0; xwet$Riparian = 0
  xwet = xwet[c(1:2,5:8)]
  xwet = xwet[ ,  c('WET_ID','PATHID','COMID','WSA_9', 'Riparian','LeveeInfluence')]
  in_table = rbind(in_table, xwet)
  write.csv(in_table, paste0(out_path, 'LeveeInfluence_', rpus[i], '.csv'), row.names=F)
  }
```

#Add COMID and eco9 to tables
Wetland basin areas
```{r}
accum_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/Accumulation/'
table_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables/'
out_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables_final/'
final_lookup = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables_final/'

files = list.files(accum_path, pattern = 'NLCD'); rpus = c()
for(i in 1:length(files)){
  #print(files[i])
  rpus[i] = substr(files[i], 18, 20)
}

for(i in 1:length(rpus)){
  print(rpus[i])
  
  in_table = read.csv(paste0(table_path, 'BasinAreaSqKm_', rpus[i], '.csv'))

  nrow(in_table)
  head(in_table)
  allwet = read.csv(paste0(final_lookup, 'AllWetlands_StreamLink_Lookup_', rpus[i], '.csv'))
  head(allwet)

  in_table = merge(in_table, allwet, by.x='BASINID', by.y='WET_ID')  
  
  head(in_table)
  names(in_table)
  in_table = in_table[, c('BASINID','COMID','STRMLNK_ID','WSA_9', 'AreaSqKm')]
  #in_table$Riparian = 0
  names(in_table) = c('WET_ID','COMID','PATHID','WSA_9', 'AreaSqKm')
#   xwet = read.csv(paste0(final_lookup, 'WetlandsNoPath_StreamLink_Lookup_', rpus[i], '.csv'))
#   xwet$PATHID = NA; xwet$LeveeInfluence = 0; xwet$Riparian = 0
#   xwet = xwet[c(1:2,5:8)]
#   xwet = xwet[ ,  c('WET_ID','PATHID','COMID','WSA_9', 'Riparian','LeveeInfluence')]
#  in_table = rbind(in_table, xwet)
  write.csv(in_table, paste0(out_path, 'WetBasinArea_', rpus[i], '.csv'), row.names=F)
  }
```



#Make cathment tables
```{r, eval=F}
library(dplyr)
old_lookup = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/old_LookupTables/'
lookup_tables = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables_final/'
master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
wet_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables_final/'
cat_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/NHDPlusCatchmentTables/'


# overland
master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
for(i in 1:length(rpus)){
  print(rpus[i])
  travel = read.csv(paste0(wet_path, 'OverlandFlow_', rpus[i], '.csv'))
  travel2 = travel[travel$Riparian != 100, ]
  #travel = travel[!is.na(travel$t_overland), ]
  #cat_lookup = read.csv(paste0(lookup_tables, 'Wetlands_NHDPlusCat_Lookup_', rpus[i], '.csv'))
  #travel$COMID = cat_lookup$COMID[match(travel$WETID, cat_lookup$WET_ID)]
  if (i==1){
    final = group_by(travel,COMID)
    final = summarize(final, t_overland_mean_all = mean(t_overland), t_overland_med_all = median(t_overland))
    
    add = group_by(travel2, COMID)
    add = summarize(add, t_overland_mean_iso = mean(t_overland), t_overland_med_iso = median(t_overland))
    
    final = merge(final, add, all=T)
    
    final$WSA_9 = master_table$WSA_9[match(final$COMID, master_table$COMID)]
  }
  if (i> 1){
    temp = group_by(travel,COMID)
    temp = summarize(temp, t_overland_mean_all = mean(t_overland), t_overland_med_all = median(t_overland))
    
    add = group_by(travel2, COMID)
    add = summarize(add, t_overland_mean_iso = mean(t_overland), t_overland_med_iso = median(t_overland))
    
    temp = merge(temp, add, all=T)
    
    temp$WSA_9 = master_table$WSA_9[match(temp$COMID, master_table$COMID)]
    final = rbind(final, temp)
  } 
}

master_table$t_overland_mean_all = final$t_overland_mean_all[match(master_table$COMID, final$COMID)]
master_table$t_overland_med_all = final$t_overland_med_all[match(master_table$COMID, final$COMID)]
master_table$t_overland_mean_iso = final$t_overland_mean_iso[match(master_table$COMID, final$COMID)]
master_table$t_overland_med_iso = final$t_overland_med_iso[match(master_table$COMID, final$COMID)]

write.csv(master_table, paste0(cat_path, 'OverlandFlow.csv'), row.names=F)
rmNA = na.omit(master_table)
write.csv(rmNA, file = paste0(cat_path, 'OverlandFlow_narm.csv'), row.names=F)


# shallow
master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
for(i in 1:length(rpus)){
  print(rpus[i])
  travel = read.csv(paste0(wet_path, 'ShallowFlow_', rpus[i], '.csv'))
  travel2 = travel[travel$Riparian != 100, ]
#   travel = travel[!is.na(travel$t_shallow), ]
#   cat_lookup = read.csv(paste0(lookup_tables, 'Wetlands_NHDPlusCat_Lookup_', rpus[i], '.csv'))
#   travel$COMID = cat_lookup$COMID[match(travel$WETID, cat_lookup$WET_ID)]
  if (i==1){
    final = group_by(travel,COMID)
    final = summarize(final, t_shallow_mean_all = mean(t_shallow), t_shallow_med_all = median(t_shallow))
    
    add = group_by(travel2, COMID)
    add = summarize(add, t_shallow_mean_iso = mean(t_shallow), t_shallow_med_iso = median(t_shallow))
    
    final = merge(final, add, all=T)
    
    final$WSA_9 = master_table$WSA_9[match(final$COMID, master_table$COMID)]
  }
  if (i> 1){
    temp = group_by(travel,COMID)
    temp = summarize(temp, t_shallow_mean_all = mean(t_shallow), t_shallow_med_all = median(t_shallow))
    
    add = group_by(travel2, COMID)
    add = summarize(add, t_shallow_mean_iso = mean(t_shallow), t_shallow_med_iso = median(t_shallow))
    
    temp = merge(temp, add, all=T)
    
    temp$WSA_9 = master_table$WSA_9[match(temp$COMID, master_table$COMID)]
    final = rbind(final, temp)
  }
}
master_table$t_shallow_mean_all = final$t_shallow_mean_all[match(master_table$COMID, final$COMID)]
master_table$t_shallow_med_all = final$t_shallow_med_all[match(master_table$COMID, final$COMID)]
master_table$t_shallow_mean_iso = final$t_shallow_mean_iso[match(master_table$COMID, final$COMID)]
master_table$t_shallow_med_iso = final$t_shallow_med_iso[match(master_table$COMID, final$COMID)]


write.csv(master_table, paste0(cat_path, 'ShallowFlow.csv'), row.names=F)
rmNA = na.omit(master_table)
write.csv(rmNA, file = paste0(cat_path, 'ShallowFlow_narm.csv'), row.names=F)

# summary of wetland type by NHDPlus catchment
master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
for(i in 1:length(rpus)){
  print(rpus[i])
  wetlands = read.csv(paste0(wet_path, 'FlowClass_', rpus[i], '.csv'))
  summary(wetlands)
  #cat_lookup = read.csv(paste0(lookup_tables, 'Wetlands_NHDPlusCat_Lookup_', rpus[i], '.csv'))
  #wetlands$COMID = cat_lookup$COMID[match(wetlands$WET_ID, cat_lookup$WET_ID)]
  wetlands$Isolated = 0
  wetlands$Isolated[wetlands$Riparian != 100] = 1
  wetlands$Group2 = 1
  
  if (i==1){
    final = group_by(wetlands,COMID)
    final = summarize(final, sumG1 = sum(Isolated), sumG2 = sum(Group2))
    final$PCTGIW = (final$sumG1/final$sumG2) *100
    final$WSA_9 = master_table$WSA_9[match(final$COMID, master_table$COMID)]
    final = final[,c('COMID','PCTGIW','WSA_9')]
    print(summary(final))
  }
  if (i> 1){
    temp = group_by(wetlands,COMID)
    temp = summarize(temp, sumG1 = sum(Isolated), sumG2 = sum(Group2))
    temp$PCTGIW = (temp$sumG1/temp$sumG2) *100
    temp$WSA_9 = master_table$WSA_9[match(temp$COMID, master_table$COMID)]
    temp = temp[,c('COMID','PCTGIW','WSA_9')]
    print(summary(temp))
    final = rbind(final, temp)
  }
}  
master_table$PCTGIW = final$PCTGIW[match(master_table$COMID, final$COMID)]
#master_table$PCTGIW = round(master_table$PCTGIW)
write.csv(master_table, paste0(cat_path, 'GIW_PERCENT.csv'), row.names=F)
rmNA = na.omit(master_table)
write.csv(rmNA, file = paste0(cat_path, 'GIW_PERCENT_narm.csv'), row.names=F)



# # Mannings
# master_table = read.csv(paste0(lookup_tables,'eco9_all.csv'))
# for(i in 1:length(rpus)){
#   print(rpus[i])
#   travel = read.csv(paste0(accum_path, 'Mannings', rpus[i], '.csv'))
#   travel = travel[!is.na(travel$GeoMean), ]
#   wetid = read.csv(paste0(lookup_tables, 'WetlandsWithPath_StreamLink_Lookup_', rpus[i], '.csv'))
#   travel$WET_ID = wetid$WET_ID[match(travel$PATHID, wetid$STRMLNK_ID)]
#   cat_lookup = read.csv(paste0(lookup_tables, 'Wetlands_NHDPlusCat_Lookup_', rpus[i], '.csv'))
#   travel$COMID = cat_lookup$COMID[match(travel$WET_ID, cat_lookup$WET_ID)]
#   if (i==1){
#     final = group_by(travel,COMID)
#     final = summarize(final, GeoMean_mean = mean(GeoMean), GeoMean_med = median(GeoMean))
#     final$WSA_9 = master_table$WSA_9[match(final$COMID, master_table$COMID)]
#   }
#   if (i> 1){
#     temp = group_by(travel,COMID)
#     temp = summarize(temp, GeoMean_mean = mean(GeoMean), GeoMean_med = median(GeoMean))
#     temp$WSA_9 = master_table$WSA_9[match(temp$COMID, master_table$COMID)]
#     final = rbind(final, temp)
#   }
# }
# master_table$GeoMean_mean = final$GeoMean_mean[match(master_table$COMID, final$COMID)]
# master_table$GeoMean_med = final$GeoMean_med[match(master_table$COMID, final$COMID)]
# write.csv(master_table, paste0(cat_path, 'Mannings.csv'), row.names=F)

# Impervous
master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
for(i in 1:length(rpus)){
  print(rpus[i])
  intable = read.csv(paste0(wet_path, 'Impervious_', rpus[i], '.csv'))
  intable = intable[intable$Riparian != 100, ]
  print(summary(intable$BasinImperv))}
#   travel = travel[!is.na(travel$t_shallow), ]
#   cat_lookup = read.csv(paste0(lookup_tables, 'Wetlands_NHDPlusCat_Lookup_', rpus[i], '.csv'))
#   travel$COMID = cat_lookup$COMID[match(travel$WETID, cat_lookup$WET_ID)]
  if (i==1){
    final = group_by(intable,COMID)
    final = summarize(final, Impervious = mean(BasinImperv))

    final$WSA_9 = master_table$WSA_9[match(final$COMID, master_table$COMID)]
  }
  if (i> 1){
    temp = group_by(intable,COMID)
    temp = summarize(temp, Impervious = mean(BasinImperv))

    temp$WSA_9 = master_table$WSA_9[match(temp$COMID, master_table$COMID)]
    final = rbind(final, temp)
  }
}
master_table$Impervious = final$Impervious[match(master_table$COMID, final$COMID)]
write.csv(master_table, paste0(cat_path, 'PctImpervious.csv'), row.names=F)

# Levees
master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
for(i in 1:length(rpus)){
  print(rpus[i])
  intable = read.csv(paste0(wet_path, 'LeveeInfluence_', rpus[i], '.csv'))
  intable = intable[intable$Riparian != 100, ]
  intable$denom = 1
#   travel = travel[!is.na(travel$t_shallow), ]
#   cat_lookup = read.csv(paste0(lookup_tables, 'Wetlands_NHDPlusCat_Lookup_', rpus[i], '.csv'))
#   travel$COMID = cat_lookup$COMID[match(travel$WETID, cat_lookup$WET_ID)]
  if (i==1){
    final = group_by(intable,COMID)
    final = summarize(final, numer = sum(LeveeInfluence), denom = sum(denom))
    final$PctLevee = (final$numer / final$denom) * 100
    final$WSA_9 = master_table$WSA_9[match(final$COMID, master_table$COMID)]
    final = final[ , c('COMID','PctLevee','WSA_9')]
  }
  if (i> 1){
    temp = group_by(intable,COMID)
    temp = summarize(temp, numer = sum(LeveeInfluence), denom = sum(denom))
    temp$PctLevee = (temp$numer / temp$denom) * 100
    temp$WSA_9 = master_table$WSA_9[match(temp$COMID, master_table$COMID)]
    temp = temp[ , c('COMID','PctLevee','WSA_9')]
    final = rbind(final, temp)
  }
}
master_table$PctLevee = final$PctLevee[match(master_table$COMID, final$COMID)]
write.csv(master_table, paste0(cat_path, 'PctLeveeInfluence.csv'), row.names=F)

# Ag drainage (basin)
master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
for(i in 1:length(rpus)){
  print(rpus[i])
  intable = read.csv(paste0(wet_path, 'AgDrainage_Basin_', rpus[i], '.csv'))
  intable = intable[intable$Riparian != 100, ]
  print(summary(intable$PctAgDrainBasin))
#   travel = travel[!is.na(travel$t_shallow), ]
#   cat_lookup = read.csv(paste0(lookup_tables, 'Wetlands_NHDPlusCat_Lookup_', rpus[i], '.csv'))
#   travel$COMID = cat_lookup$COMID[match(travel$WETID, cat_lookup$WET_ID)]
  if (i==1){
    final = group_by(intable,COMID)
    final = summarize(final, PctAgDrainBasin = mean(PctAgDrainBasin))
  }
  if (i> 1){
    temp = group_by(intable,COMID)
    temp = summarize(temp, PctAgDrainBasin = mean(PctAgDrainBasin))
    final = rbind(final, temp)
  }
}
master_table$PctAgDrainBasin = final$PctAgDrainBasin[match(master_table$COMID, final$COMID)]
write.csv(master_table, paste0(cat_path, 'PctAgDrainBasin.csv'), row.names=F)

# Ag drainage (path)
master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
for(i in 1:length(rpus)){
  print(rpus[i])
  intable = read.csv(paste0(wet_path, 'AgDrainage_Path_', rpus[i], '.csv'))
  intable = intable[intable$Riparian != 100, ]
  print(summary(intable$PctAgDrainPath))
#   travel = travel[!is.na(travel$t_shallow), ]
#   cat_lookup = read.csv(paste0(lookup_tables, 'Wetlands_NHDPlusCat_Lookup_', rpus[i], '.csv'))
#   travel$COMID = cat_lookup$COMID[match(travel$WETID, cat_lookup$WET_ID)]
  if (i==1){
    final = group_by(intable,COMID)
    final = summarize(final, PctAgDrainPath = mean(PctAgDrainPath))
  }
  if (i> 1){
    temp = group_by(intable,COMID)
    temp = summarize(temp, PctAgDrainBasin = mean(PctAgDrainPath))
    final = rbind(final, temp)
  }
}
master_table$PctAgDrainPath = final$PctAgDrainPath[match(master_table$COMID, final$COMID)]
write.csv(master_table, paste0(cat_path, 'PctAgDrainPath.csv'), row.names=F)

# Wetland basin areas
master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
for(i in 1:length(rpus)){
  print(rpus[i])
  intable = read.csv(paste0(wet_path, 'WetBasinArea_', rpus[i], '.csv'))
  #intable = intable[intable$Riparian != 100, ]
  #print(summary(intable$PctAgDrainPath))
#   travel = travel[!is.na(travel$t_shallow), ]
#   cat_lookup = read.csv(paste0(lookup_tables, 'Wetlands_NHDPlusCat_Lookup_', rpus[i], '.csv'))
#   travel$COMID = cat_lookup$COMID[match(travel$WETID, cat_lookup$WET_ID)]
  if (i==1){
    final = group_by(intable,COMID)
    final = summarize(final, meanBasinArea = mean(AreaSqKm), totalBasinAreas = sum(AreaSqKm))
  }
  if (i> 1){
    temp = group_by(intable,COMID)
    temp = summarize(temp, meanBasinArea = mean(AreaSqKm), totalBasinAreas = sum(AreaSqKm))
    final = rbind(final, temp)
  }
}
master_table$meanBasinArea = final$meanBasinArea[match(master_table$COMID, final$COMID)]
master_table$totalBasinAreas = final$totalBasinAreas[match(master_table$COMID, final$COMID)]
write.csv(master_table, paste0(cat_path, 'WetBasinAreas.csv'), row.names=F)


```    

# Dominant flow class for catchments
```{r, eval=F}
accum_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/Accumulation/'

files = list.files(accum_path, pattern = 'NLCD'); rpus = c()
for(i in 1:length(files)){
  #print(files[i])
  rpus[i] = substr(files[i], 18, 20)
}

old_lookup = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/old_LookupTables/'
lookup_tables = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables_final/'
#master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
wet_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables_final/'
cat_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/NHDPlusCatchmentTables/'

master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
for(i in 1:length(rpus)){
  print(rpus[i])
  wetlands = read.csv(paste0(wet_path, 'FlowClass_', rpus[i], '.csv'))
  #print(summary(wetlands$DomFlow))}
  wetlands = wetlands[wetlands$DomFlow != 'Riparian', ]
  
  if (i==1){
    final = group_by(wetlands,COMID)
    levels(final$DomFlow)
    final = summarize(final, DomFlow = names(which.max(table(DomFlow))))
    #final$WSA_9 = master_table$WSA_9[match(final$COMID, master_table$COMID)]
    #final = final[,c('COMID','DomFlow','WSA_9')]
  }
  if (i> 1){
    temp = group_by(wetlands,COMID)
    levels(temp$DomFlow)
    temp = summarize(temp, DomFlow = names(which.max(table(DomFlow))))
    #temp$WSA_9 = master_table$WSA_9[match(temp$COMID, master_table$COMID)]
    #temp = temp[,c('COMID','DomFlow','WSA_9')]
    final = rbind(final, temp)
  }
}
levels(as.factor(final$DomFlow))
master_table$DomFlow_2nd = final$DomFlow[match(master_table$COMID, final$COMID)]
master_table$DomCode_2nd = NA
master_table$DomCode_2nd[master_table$DomFlow_2nd=='Overland'] = 1
master_table$DomCode_2nd[master_table$DomFlow_2nd=='Riparian'] = 2
master_table$DomCode_2nd[master_table$DomFlow_2nd=='Shallow'] = 3
master_table$DomCode_2nd[master_table$DomFlow_2nd=='ShallowDeep'] = 4

write.csv(master_table, paste0(cat_path, 'DOMFLOW_2nd.csv'), row.names=F)

```

# Dominant flow class for catchments (excluding riparian)
```{r, eval=F}
accum_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/Accumulation/'

files = list.files(accum_path, pattern = 'NLCD'); rpus = c()
for(i in 1:length(files)){
  #print(files[i])
  rpus[i] = substr(files[i], 18, 20)
}

old_lookup = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/old_LookupTables/'
lookup_tables = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables_final/'
#master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
wet_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables_final/'
cat_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/NHDPlusCatchmentTables/'

master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
for(i in 1:length(rpus)){
  print(rpus[i])
  wetlands = read.csv(paste0(wet_path, 'FlowClass_', rpus[i], '.csv'))
  #print(summary(wetlands$DomFlow))}
  
  if (i==1){
    final = group_by(wetlands,COMID)
    levels(final$DomFlow)
    final = summarize(final, DomFlow = names(which.max(table(DomFlow))))
    #final$WSA_9 = master_table$WSA_9[match(final$COMID, master_table$COMID)]
    #final = final[,c('COMID','DomFlow','WSA_9')]
  }
  if (i> 1){
    temp = group_by(wetlands,COMID)
    levels(temp$DomFlow)
    temp = summarize(temp, DomFlow = names(which.max(table(DomFlow))))
    #temp$WSA_9 = master_table$WSA_9[match(temp$COMID, master_table$COMID)]
    #temp = temp[,c('COMID','DomFlow','WSA_9')]
    final = rbind(final, temp)
  }
}
levels(as.factor(final$DomFlow))
master_table$DomFlow = final$DomFlow[match(master_table$COMID, final$COMID)]
master_table$DomCode = NA
master_table$DomCode[master_table$DomFlow=='Overland'] = 1
master_table$DomCode[master_table$DomFlow=='Riparian'] = 2

write.csv(master_table, paste0(cat_path, 'DOMFLOW.csv'), row.names=F)
#rmNA = na.omit(master_table)
#write.csv(rmNA, file = paste0(cat_path, 'DOMFLOW_narm.csv'), row.names=F)
```



# Dominant flood frequency for catchments
```{r, eval=F}
accum_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/Accumulation/'

files = list.files(accum_path, pattern = 'NLCD'); rpus = c()
for(i in 1:length(files)){
  #print(files[i])
  rpus[i] = substr(files[i], 18, 20)
}

old_lookup = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/old_LookupTables/'
lookup_tables = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables_final/'
master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
wet_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables_final/'
cat_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/NHDPlusCatchmentTables/'

master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
for(i in 1:length(rpus)){
  print(rpus[i])
  wetlands = read.csv(paste0(wet_path, 'DomFldFreqCls_', rpus[i], '.csv'))
  summary(wetlands)
  #wetlands$DomFldFreqCls = as.factor(wetlands$DomFldFreqCls)
  #levels(wetlands$DomFldFreqCls) = c("VALUE0","VALUE1","VALUE2","VALUE3")
  if (i==1){
    final = group_by(wetlands,COMID)
    levels(final$DomFldFreqCls)
    #final$DomFldFreqCls = as.character(final$DomFldFreqCls)
    final = summarize(final, DomFldFreqCls = names(which.max(table(DomFldFreqCls))))
    #final$WSA_9 = master_table$WSA_9[match(final$COMID, master_table$COMID)]
    #final = final[,c('COMID','DomFldFreqCls','WSA_9')]
  }
  if (i> 1){
    temp = group_by(wetlands,COMID)
    #levels(temp$DomFlow)
    temp = summarize(temp, DomFldFreqCls = names(which.max(table(DomFldFreqCls))))
    #temp$WSA_9 = master_table$WSA_9[match(temp$COMID, master_table$COMID)]
    #temp = temp[,c('COMID','DomFldFreqCls','WSA_9')]
    final = rbind(final, temp)
  }
}

master_table$DomFldFreqCls = final$DomFldFreqCls[match(master_table$COMID, final$COMID)]
levels(as.factor(master_table$DomFldFreqCls))
master_table$DomCode = NA
master_table$DomCode[master_table$DomFldFreqCls=='VALUE_0'] = 0
master_table$DomCode[master_table$DomFldFreqCls=='VALUE_1'] = 1
master_table$DomCode[master_table$DomFldFreqCls=='VALUE_2'] = 2
master_table$DomCode[master_table$DomFldFreqCls=='VALUE_3'] = 3
print(summary(master_table))
write.csv(master_table, paste0(cat_path, 'DomFldFreqCls.csv'), row.names=F)
rmNA = na.omit(master_table)
write.csv(rmNA, file = paste0(cat_path, 'DomFldFreqCls_narm.csv'), row.names=F)
```

# Dominant Drainage Class for catchments
```{r, eval=F}
accum_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/Accumulation/'

files = list.files(accum_path, pattern = 'NLCD'); rpus = c()
for(i in 1:length(files)){
  #print(files[i])
  rpus[i] = substr(files[i], 18, 20)
}

old_lookup = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/old_LookupTables/'
lookup_tables = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables_final/'
master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
wet_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables_final/'
cat_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/NHDPlusCatchmentTables/'

master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
for(i in 1:length(rpus)){
  print(rpus[i])
  wetlands = read.csv(paste0(wet_path, 'DrainClass_', rpus[i], '.csv'))
  head(wetlands)
  
  if (i==1){
    #wetlands$DomDrainClass = as.character(wetlands$DomDrainClass)
    final = group_by(wetlands,COMID)
    #levels(as.factor(final$DomDrainClass))
    final = summarize(final, DomDrainClass = names(which.max(table(DomDrainClass))))
    #final$WSA_9 = master_table$WSA_9[match(final$COMID, master_table$COMID)]
    #final = final[,c('COMID','DomDrainClass','WSA_9')]
  }
  if (i> 1){
    temp = group_by(wetlands,COMID)
    #levels(as.factor(temp$DomDrainClass))
    
    temp = summarize(temp, DomDrainClass = names(which.max(table(DomDrainClass))))
    #temp$WSA_9 = master_table$WSA_9[match(temp$COMID, master_table$COMID)]
    #temp = temp[,c('COMID','DomDrainClass','WSA_9')]
    final = rbind(final, temp)
  }
}

master_table$DomDrainClass = final$DomDrainClass[match(master_table$COMID, final$COMID)]
levels(as.factor(master_table$DomDrainClass))

master_table$DomCode = NA
master_table$DomCode[master_table$DomDrainClass=='VALUE_0'] = 0
master_table$DomCode[master_table$DomDrainClass=='VALUE_1'] = 1
master_table$DomCode[master_table$DomDrainClass=='VALUE_2'] = 2
master_table$DomCode[master_table$DomDrainClass=='VALUE_3'] = 3
print(summary(master_table))
write.csv(master_table, paste0(cat_path, 'DomDrainClass.csv'), row.names=F)
```


#Make Drain Class table
```{r, eval=F}
library(dplyr)
r = c('VALUE_0', 'VALUE_1', 'VALUE_2', 'VALUE_3')

for(i in 1:length(rpus)){
  
  print(rpus[i])
  flow_cls = read.csv(paste0(accum_path, 'DrainClass_PERCENT_', rpus[i], '.csv'))   
  missing <- r[is.na(match(r, names(flow_cls)))]
  flow_cls[,paste(missing)] <- c(0)
  
  flow_cls = flow_cls[, c('PathID', r)] #make in right order
  #print(summary(flow_cls))
  
  flow_cls[ ,2:5] = prop.table(as.matrix(flow_cls[ ,2:5]), margin = 1) * 100

  type_names = names(flow_cls)[2:5]  
  type_num = c(0,1,2,3)
  flow_cls = na.omit(flow_cls)  
  flow_cls$DomFlow = type_names[apply(flow_cls[, 2:5], 1, which.max)]
  flow_cls$DomCls = type_num[apply(flow_cls[, 2:5], 1, which.max)]
  print(summary(flow_cls))}
  write.csv(flow_cls, paste0(final_path, 'DrainClass_', rpus[i], '.csv'), row.names=F)
```


#Get wetland areas
```{r, eval=FALSE}
library(foreign)
wet_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/WetlandTables_final/'
wetland_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/AllWetlands_rpu/'
accum_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/Accumulation/'
final_lookup = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/LookupTables_final/'
cat_path = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/NHDPlusCatchmentTables/'
master_table = read.csv(paste0(old_lookup,'eco9_all.csv'))
files = list.files(accum_path, pattern = 'NLCD'); rpus = c()
for(i in 1:length(files)){
  #print(files[i])
  rpus[i] = substr(files[i], 18, 20)
}

for(i in 1:length(rpus)){
  print(rpus[i])
  
  wetlands = read.dbf(paste0(wetland_path, 'Wetlands_', rpus[i], '.tif.vat.dbf'))
  allwet = read.csv(paste0(final_lookup, 'AllWetlands_StreamLink_Lookup_', rpus[i], '.csv'))
  flowclass = read.csv(paste0(wet_path, 'FlowClass_', rpus[i], '.csv'))
  
  names(wetlands) = toupper(names(wetlands))
  wetlands$AREA = (wetlands$COUNT * 900) / 1e6
  
  wetlands = wetlands[, c('VALUE', 'AREA')]
  names(wetlands) = c('WET_ID','WetlandArea')
  
  wetlands$COMID = allwet$COMID[match(wetlands$WET_ID, allwet$WET_ID)]
  wetlands$WSA_9 = allwet$WSA_9[match(wetlands$WET_ID, allwet$WET_ID)]
  wetlands$PATHID = allwet$STRMLNK_ID[match(wetlands$WET_ID, allwet$WET_ID)]
  wetlands$DomFlow = flowclass$DomFlow[match(wetlands$WET_ID, flowclass$WET_ID)]
    
  
  if(i == 1){
    outarea = wetlands
  }else{
    outarea = rbind(outarea, wetlands)
  }  
}

area_stats = group_by(outarea, COMID)
area_stats = summarize(area_stats, WetldArea_mean = mean(WetlandArea), WetldArea_sum = sum(WetlandArea))

master_table$WetldArea_mean = NA
master_table$WetldArea_sum = NA

master_table$WetldArea_mean = area_stats$WetldArea_mean[match(master_table$COMID, area_stats$COMID)]
master_table$WetldArea_sum = area_stats$WetldArea_sum[match(master_table$COMID, area_stats$COMID)]

write.csv(area_stats, file=paste0(cat_path, 'WetlandAreas.csv'))



for(i in 1:length(rpus)){
  print(rpus[i])

  allwet = read.csv(paste0(final_lookup, 'AllWetlands_StreamLink_Lookup_', rpus[i], '.csv'))
  
  if(i == 1){
    outwet = allwet
  }else{
    outwet = rbind(outwet, allwet)
  }  
}

outwet = outwet[, c('COMID','GRIDCODE')]

tmp = unique(outwet)

saveRDS(tmp, file = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/FinalTables/ForScott/comid_gridcode.rds')


```







