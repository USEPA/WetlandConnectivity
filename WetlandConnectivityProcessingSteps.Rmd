---
title: "Wetland Connectivity Processing Steps"
author: "Marc Weber"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    theme: yeti
    highlighted: default 
    toc: yes
---

The following steps lay out the approach to generate wetland flow paths and calculate wetland hydrological connectivity at a national level

### Derive NLCD 2011 based wetlands
1. Extract wetland cells from NLCD 2011 raster
2. Use Arc region group tool to define contiguous wetland cells and assign a unique ID
```{r, engine='python', engine.path='C:/Python27/ArcGIS10.3/python.exe', eval=F}
# Import arcpy module
import arcpy
import os
from arcpy.sa import *
arcpy.CheckOutExtension("Spatial")
from arcpy import env

# Set variables
working_dir = "J:/GitProjects/Wetland Connectivity/SpatialData"
nlcd = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/StreamCat/LandscapeRasters/QAComplete/nlcd2006.tif'

# Derive NLCD based wetlands
NLCD = Raster(nlcd)
wetlands = Con((NLCD == 90) | (NLCD == 95), 1,)
if not arcpy.Exists(working_dir + "/Wetlands" + ".tif"):
    wetlands.save(working_dir + "/Wetlands.tif")

# Now create unique wetland groups of contiguous wetland cells
Wetlands = Raster(working_dir + "/Wetlands.tif")
WetlandRegions = RegionGroup(Wetlands, "EIGHT", "WITHIN", "NO_LINK", "")
if not arcpy.Exists(working_dir + "/WetlandsRgnGrp.tif"):
    WetlandRegions.save(working_dir + "/WetlandsRgnGrp.tif")   
```

### Convert Wetland Groups to polygons and drop wetlands touching NHDPlus streamlines
1. Create vector shapefile features of wetland groups by NHDPlusV2 VPU (vector processing unit)
2. Select only wetland groups that don't touch NHDPlus flowlines and save as vector and raster
```{r, engine='python', engine.path='C:/Python27/ArcGIS10.3/python.exe', eval=F}
# Import arcpy module
import arcpy
import os
from arcpy.sa import *
arcpy.CheckOutExtension("Spatial")
from arcpy import env

# Set variables
working_dir = "J:/GitProjects/Wetland Connectivity/SpatialData"
nhddir = "L:/Priv/CORFiles/Geospatial_Library/Data/RESOURCE/PHYSICAL/HYDROLOGY/NHDPlusV21"
Wetlands_tif = "WetlandsRgnGrp.tif"
# Define the NHDPlus hydro-regions to loop through and process as a dictionary
inputs = {'CA':['18'],'CO':['14','15'],'GB':['16'],'GL':['04'],'MA':['02'],'MS':['05','06','07','08','10L','10U','11'],
          'NE':['01'],'PN':['17'],'RG':['13'],'SA':['03N','03S','03W'],'SR':['09'],'TX':['12']}

for region in inputs.keys():
    for hydro in inputs[region]:
        print 'on region ' + region + ' and hydro number ' + hydro
        arcpy.env.workspace = working_dir
        Wetlands_Rgn = 'Wetlands' + hydro + '.tif'
        Wetlands_Shp = "Wetlands" + hydro + '.shp'
        
        MaskRaster = nhddir + "/NHDPlus" + region + "/NHDPlus" + hydro + "/NHDPlusCatchment/cat"
               
        if not arcpy.Exists(Wetlands_Rgn):
            # Execute ExtractByMask
            arcpy.env.snapRaster = MaskRaster
            arcpy.env.cellSize = "30"
            arcpy.env.mask = MaskRaster
            arcpy.env.extent = MaskRaster
            outExtractByMask = ExtractByMask(Wetlands_tif, MaskRaster)
            # Save the output 
            outExtractByMask.save(Wetlands_Rgn)
        if not arcpy.Exists(Wetlands_Shp):   
            # Process: Raster to Polygon
            arcpy.RasterToPolygon_conversion(Wetlands_Rgn, Wetlands_Shp, "SIMPLIFY", "VALUE")

        # Process: Make Feature Layer
        arcpy.MakeFeatureLayer_management(Wetlands_Shp, "Wetlands_%s"%(hydro))
        
        # Process: Make Feature Layer
        Flowlines = nhddir + "/NHDPlus" + region + "/NHDPlus" + hydro + "/NHDSnapshot/Hydrography/NHDFlowline.shp"
        arcpy.MakeFeatureLayer_management(Flowlines, "Flowlines")
        
        # Process: Select Layer By Location
        arcpy.SelectLayerByLocation_management("Wetlands_%s"%(hydro), "INTERSECT", "Flowlines", "", "NEW_SELECTION")
        arcpy.SelectLayerByLocation_management("Wetlands_%s"%(hydro), None, None, "", "SWITCH_SELECTION")
        IsolatedWetlands = working_dir + '/IsolatedWetlands/Wetlands_%s'%(hydro)
        if not arcpy.Exists(IsolatedWetlands): 
            # Process: Feature Class To Shapefile (multiple)
            arcpy.FeatureClassToShapefile_conversion('Wetlands_%s'%(hydro), working_dir + '/IsolatedWetlands')
        arcpy.Delete_management('Wetlands_%s'%(hydro))
        arcpy.Delete_management("Flowlines")
```

### Use Full Streams to test if wetlands are isolated from stream network
1. Build VAT for wetland raster
2. Set non-null values in fdrnull raster = 1
3. Multiply rasters and build VAT of output of (2)
4. Compare counts of regions in VATS (not there)
```{r, engine='python', engine.path='C:/Python27/ArcGIS10.3/python.exe', eval=F}
import arcpy
import os
from arcpy.sa import *
arcpy.CheckOutExtension("spatial")
from collections import deque, defaultdict
import pysal as ps
import pandas as pd
import numpy as np
import numpy.ma as ma
from osgeo import gdal
import osr

def dbf2DF(dbfile, upper=True):
    db = ps.open(dbfile)
    cols = {col: db.by_col(col) for col in db.header}
    db.close()  #Close dbf 
    pandasDF = pd.DataFrame(cols)
    if upper == True:
        pandasDF.columns = pandasDF.columns.str.upper()              
    return pandasDF


nhddir = 'L:/Priv/CORFiles/Geospatial_Library/Data/RESOURCE/PHYSICAL/HYDROLOGY/NHDPlusV21'
#working_dir = 'J:/GitProjects/Wetland Connectivity/SpatialData'
working_dir = 'D:/WorkFolder/WetConnect_Aug2016'
wetlands_dir = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/AllWetlands'
watermask_dir = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/StreamCat/LandscapeRasters/QAComplete/WaterMask'

inputs = {'CA':['18'],'CO':['14','15'],'GB':['16'],'GL':['04'],'MA':['02'],'MS':['05','06','07','08','10L','10U','11'],
          'NE':['01'],'PN':['17'],'RG':['13'],'SA':['03N','03S','03W'],'SR':['09'],'TX':['12']}
          
for region in inputs.keys():
    for hydro in inputs[region]:
        print 'on region ' + region + ' and hydro number ' + hydro
        for dirs in os.listdir(nhddir + "/NHDPlus%s/NHDPlus%s"%(region, hydro)):
            if dirs.count("FdrFac") and not dirs.count('.txt') and not dirs.count('.7z'):
                rpu =  dirs[-3:]
                fdr = Raster(nhddir +"/NHDPlus" +region + "/NHDPlus" + hydro + "/NHDPlusFdrFac"  + rpu + "/fdr")
                # Get full streams              
                fullstreams = Raster(watermask_dir +"/FullStreams"  + rpu + ".tif")
                streamcon = Con(IsNull(fullstreams), 1, 0) #Set null pixels to zero, else stay the same
                # Set env
                arcpy.env.snapRaster = fdr
                arcpy.env.cellSize = "30"
                arcpy.env.mask = fdr
                arcpy.env.extent = fdr
                # Get wetland raster and build VAT
                #tester_all = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/AllWetlands/Wetlands_14.tif'
                wetland_tif = wetlands_dir + '/Wetlands_' + hydro + '.tif' 
                if not os.path.isfile(wetland_tif + '.vat.dbf'): 
                    arcpy.BuildRasterAttributeTable_management(wetland_tif, "Overwrite")
                wetland = Raster(wetland_tif)
                wetcon = Con(IsNull(wetland),0, wetland)
                # Multiply to create temporary query wetland
                tmpWet = streamcon * wetcon
                tmpWet.save(working_dir + '/ScratchDir/queryWetland_' + rpu + '.tif')
                arcpy.BuildRasterAttributeTable_management(working_dir + '/ScratchDir/queryWetland_' + rpu + '.tif', "Overwrite")
                
                #Delete tester - 
                tester = working_dir + '/ScratchDir/queryWetland_14a.tif.vat.dbf'
                
                allwet = dbf2DF(wetland_tif + '.vat.dbf')
                lesswet = dbf2DF(tester) #Delete this line
                #lesswet = dbf2DF(working_dir + '/ScratchDir/queryWetland_' + dirs[-3:] + '.tif.vat.dbf')
    
                new = pd.merge(allwet, lesswet, on = 'VALUE', how = 'left')                
                isolated = new.loc[new['COUNT_x'] == new['COUNT_y']]
                isolated = np.array(isolated.COUNT_x)#.astype(int)
                         
                wetland_arr = gdal.Open(wetland_tif)
                OutTimes_arr = np.array(wetland_arr)
                
                # Now use the two raster attribute tables to find any wetland groups where count is different between the two.
                # These will be wetlands that touch streams

```


### Generate wetland points for each wetland group
1. Generate points for each raster cell in wetland groups
2. Use geopandas to select just the point in each group with largest flow accumulation (the wetland outlet)
```{r, engine='python', engine.path='C:/Python27/ArcGIS10.3/python.exe', eval=F}
import arcpy
import os
from arcpy.sa import *
arcpy.CheckOutExtension("Spatial")
from arcpy import env
import geopandas as gp
import pandas as pd
from datetime import datetime

nhddir = "L:/Priv/CORFiles/Geospatial_Library/Data/RESOURCE/PHYSICAL/HYDROLOGY/NHDPlusV21"
working_dir = 'J:/GitProjects/Wetland Connectivity/SpatialData'
wetlands_dir = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/AllWetlands'
watermask_dir = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/StreamCat/LandscapeRasters/QAComplete/WaterMask'

inputs = {'CA':['18'],'CO':['14','15'],'GB':['16'],'GL':['04'],'MA':['02'],'MS':['05','06','07','08','10L','10U','11'],
          'NE':['01'],'PN':['17'],'RG':['13'],'SA':['03N','03S','03W'],'SR':['09'],'TX':['12']}

for region in inputs.keys():
    for hydro in inputs[region]:
        print 'on region ' + region + ' and hydro number ' + hydro
        for dirs in os.listdir(nhddir + "/NHDPlus%s/NHDPlus%s"%(region, hydro)):
            if dirs.count("FdrFac") and not dirs.count('.txt') and not dirs.count('.7z'):
                print dirs[-3:]
                # Execute ExtractValuesToPoints to get flow accumulation for each wetland region grid point
                fac = nhddir +"/NHDPlus" +region + "/NHDPlus" + hydro + "/NHDPlusFdrFac"  + dirs[-3:] + "/fac"
                
                # Raster to points
                outPoint = working_dir + "/ScratchDir/RasterPoints" + dirs[-3:] + ".shp"
                # Execute RasterToPoint
                WetlandRegions = working_dir + "/Wetlands" + dirs[-3:] + ".tif"
                if not arcpy.Exists(outPoint):
                    arcpy.RasterToPoint_conversion(WetlandRegions, outPoint, "VALUE")
                
                outPointFac = working_dir + "/ScratchDir/PointFac" + dirs[-3:] +  ".shp"
                if not arcpy.Exists(outPointFac):
                    ExtractValuesToPoints(outPoint, fac, outPointFac,"", "ALL")
                
                # Process: Make Feature Layer
                arcpy.MakeFeatureLayer_management(outPointFac, "FacPoints")
                
                # Process: Make Feature Layer
                BoundaryUnits = nhddir + "/NHDPlusGlobalData/BoundaryUnit.shp"
                arcpy.MakeFeatureLayer_management(BoundaryUnits, "BoundaryUnit", "\"UnitID\" = '%s'"%(dirs[-3:]))
                
                # Process: Select Layer By Location
                arcpy.SelectLayerByLocation_management("FacPoints", "INTERSECT", "BoundaryUnit", "", "NEW_SELECTION")
                
                # Process: Feature Class To Shapefile (multiple)
                arcpy.FeatureClassToShapefile_conversion("FacPoints", working_dir + "/ScratchDir")
                
                # Use Pandas to get the minimum flow distance point for each wetland region group ID
                WetPoints = gp.GeoDataFrame.from_file(working_dir + "/ScratchDir/FacPoints.shp")
                # First we'll drop all the -999 sites - these are wetland grid cells in the stream
                WetPoints = WetPoints.loc[WetPoints.RASTERVALU!=-9999]
                # Now we'll group points by wetland region group maximum flow accumulation
                WetPoints = WetPoints.loc[WetPoints.groupby("GRID_CODE")["RASTERVALU"].idxmax()]
                # And then we'll export to a text file after grabbing coordinates as fields we add
                df = WetPoints.drop('geometry', axis=1)  # df is a DataFrame, not GeoDataFrame after the drop
                def getXY(pt):
                    return (pt.x, pt.y)
                centroidseries = WetPoints['geometry'].centroid
                x,y = [list(t) for t in zip(*map(getXY, centroidseries))]
                WetPoints['XCOORD'] = x
                WetPoints['YCOORD'] = y
                if not arcpy.Exists(working_dir + "/WetlandPoints" + dirs[-3:] +".shp"):
                    WetPoints.to_file(working_dir + "/WetlandPoints" + dirs[-3:]+ ".shp", driver = 'ESRI Shapefile')  
                df['XCOORD'] = x
                df['YCOORD'] = y
                df.head()
                #df[x] = WetPoints.geometry.apply(lambda p: p.x)
                #df[y] = WetPoints.geometry.apply(lambda p: p.y)
                df.to_csv(working_dir +"/WetlandPoints" + dirs[-3:] + ".csv")
                  
                df = pd.read_csv(working_dir +"/WetlandPoints" + dirs[-3:] + ".csv") 
                        
                WetPoints = working_dir + "/WetlandPoints" + dirs[-3:] + ".shp"   
                arcpy.Delete_management(outPoint)
                arcpy.Delete_management(outPointFac)
                arcpy.Delete_management("FacPoints")
                arcpy.Delete_management(working_dir + "/ScratchDir/FacPoints.shp")    
```  

### Generate Cost Paths from each wetland outlet point to NHDPlus stream lines
1. Run cost path tool using wetland outlet points, NHDPlus hydro DEM, and NHDPlus fdr null grid
2. Convert resulting cost paths to polyl lines
3. Split the lines at wetland points (i.e. make a unique path for each particular wetland)
4. Convert back to raster paths using euclidean allocation and template raster to make align with NHDPlus flow paths

### Sort out WetlandPathsConnect, WetlandCatsConnect, making final tables
Currently in several scripts that need to be organized here

### Issues to sort out
1. The connection between wetland IDs and wetland paths not totally working.
	a. The split in flow paths happens on the cell downstream of wetland pour points
	b. Because of this, paths that flow through more than one wetland are being assigned
	   to wrong wetland ID in places
	c. The fix is to use the From-To raster to update the wetland-streamlink lookup tables (L:\Priv\CORFiles\Geospatial_Library\Data\Project\WetlandConnectivity\LookupTables)
		i. Wherever there is more than one wetland point associated with a wetland ID in the wetland - streamlink lookup table, then:
			- create a table result of point / raster extracts of wetland points and the From-To .tif
			- If the result of the point extract is NA, keep the streamlink for the wetland in the wetland-streamlink table
			- If the results of the point extract is not NA, replace the streamlink for that wetland with the 'TO' streamlink
2. Slopes for 17b are lower than neighboring regions - why?
3. Need to connect wetland catchments to get full upslope watersheds for precip
4. Calculate geometric mean


### Delineate wetland watersheds
```{r, engine='python', engine.path='C:/Python27/ArcGIS10.3/python.exe', eval=F}
# Import arcpy module
import arcpy
import os
from arcpy.sa import *
from datetime import datetime
import struct, decimal, itertools
import pysal as ps
import pandas as pd
import numpy as np
from collections import deque, defaultdict
# Check out any necessary licenses
arcpy.CheckOutExtension("spatial")

```










