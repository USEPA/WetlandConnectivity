
## Apply the same logic from StreamCat calculations to join with split metrics, grouping by SITE_ID instead of COMID.

### WetlandPoints were spatially joined to NRSA split-catchments using the script -> joinWetPts2NRSAsplitPolys.py
```{r, eval=F}
hm_path <- paste0('L:/Priv/CORFiles/Geospatial_Library/Data',
                  '/Project/WetlandConnectivity/')
n_path <- paste0(hm_path,'NitrogenModeling/')
# csv output from python script <- joinWetPts2NRSAsplitPolys.py
join_tbl <- read.csv(paste0(n_path,'join_nrsa_wet.csv'))

nrsa_join <- read.csv(paste0(n_path,'join_nrsa_all.csv'),
                     header=TRUE,sep=",")

year <- '2011'
# wetland data relating to every WetId
rds <- readRDS(paste0(hm_path,'SpatialDataInputs/',
                      'Wetlands_NLCD',year,'/FinalTables/',
                      'WetConnectMetrics_2011.rds'))
# inner join tables to groupby SITE_ID and summarize
# this isolates only the wetlands whose points lie w/in split-cats
wrk_tbl <- merge(join_tbl,rds,by='WetId')
rm(rds) # keep workspace clean, no longer needed
# the "wrk_tbl" object will be used for processing, but write out to save
write.csv(wrk_tbl,
          file = paste0(n_path,'WetConnectMetrics_',year,'wSplitCats.csv'),
          row.names = FALSE)
```

### Dominant Wetland Connectivity Type
```{r, eval=F}
# aggregate results to NRSA SITE_ID
by_COMID <- wrk_tbl %>%
            group_by(SITE_ID, Type_Full) %>%
            summarize(CatDomTypeArea=sum(WetAreaSqKm))

by_COMID <- as.data.frame(by_COMID)
zonal <- by_COMID %>% spread(Type_Full, CatDomTypeArea)
names(zonal)[2:6] <- c('CatWetOverland','CatWetRiparian','CatWetShallow',
                       'CatWetShallowDeep','CatWetMissing')
zonal[is.na(zonal)] <- 0
zonal$CatWetAreaSqKm <- rowSums(zonal[,2:6])
zonal <- zonal[c("SITE_ID","CatWetAreaSqKm","CatWetOverland","CatWetRiparian",
                 "CatWetShallow","CatWetShallowDeep","CatWetMissing")]

final <- merge(x=nrsa_join,y=zonal,by="SITE_ID",all.x=TRUE)
final[is.na(final)] <- 0
write.csv(final, 
          file=paste0(n_path,'splitMetrics/WetlandType.csv'),
          row.names = FALSE)
```

### Dominant Wetland Connectivity Frequency
```{r, eval=F}
# this is already done and written out ino the rds file now
# Ascribe Scott's type's to frequency to get dominant frequency
# wrk_tbl$Freq <- ifelse(
#                   wrk_tbl$Type_Full=="Riparian" | wrk_tbl$FreqPa==1, 
#                   "H",
#                   ifelse(wrk_tbl$FreqPa==.5, 
#                     "M", 
#                     "L"))

# aggregate results to NRSA SITE_ID
by_COMID <- wrk_tbl %>%
            group_by(SITE_ID, Freq) %>%
            summarize(CatDomTypeArea = sum(WetAreaSqKm))

by_COMID = as.data.frame(by_COMID)
zonal <- by_COMID %>% spread(Freq, CatDomTypeArea)
names(zonal)[2:5] <- c('CatHighFreq','CatLowFreq','CatMedFreq','CatMissing')
zonal[is.na(zonal)] <- 0
zonal$CatWetAreaSqKm <- rowSums(zonal[,2:5])
zonal <- zonal[c("SITE_ID","CatWetAreaSqKm","CatHighFreq",
                 "CatLowFreq","CatMedFreq","CatMissing")]
final <- merge(x=nrsa_join,y=zonal,by="SITE_ID",all.x=TRUE)
final[is.na(final)] <- 0
write.csv(final,
          file=paste0(n_path,'/splitMetrics/WetlandFreq.csv'),
          row.names=FALSE)
```

### Dominant Wetland Connectivity Magnitude
```{r, eval=F}
# this is already done and written out ino the rds file now
# Ascribe Scott's type's to frequency to get dominant frequency
# wrk_tbl$Mag <- ifelse(
#                   wrk_tbl$Type_Full=="Riparian", 
#                   "VF",
#                   ifelse(
#                     wrk_tbl$Type_Full=="Overland", 
#                     ifelse(
#                       wrk_tbl$MagOv<=24, 
#                       "VF", 
#                       ifelse(
#                         wrk_tbl$MagOv/24<=14,
#                         "FA",
#                         "MO")),
#                     ifelse(
#                       wrk_tbl$MagSh<=1, 
#                       "VF", 
#                       ifelse(
#                         wrk_tbl$MagSh<=14, 
#                         "FA", 
#                         ifelse(
#                           wrk_tbl$MagSh/365.25<=1, 
#                           "MO", 
#                           ifelse(
#                             wrk_tbl$MagSh/365.25<=10, 
#                             "SL", 
#                             "VS"))))))

# aggregate results to NRSA SITE_ID
by_COMID <- wrk_tbl %>%
            group_by(SITE_ID, Mag) %>%
            summarize(CatDomTypeArea = sum(WetAreaSqKm))

by_COMID <- as.data.frame(by_COMID)
zonal <- by_COMID %>% spread(Mag, CatDomTypeArea)
idx <- which(!is.na(match(names(zonal),"<NA>")))
names(zonal)[idx] <- "Missing"
zonal[is.na(zonal)] <- 0
names(zonal)[2:6] <- c('CatModerate','CatSlow',
                       'CatVeryFast','CatVerySlow','CatMissing')
zonal$CatWetAreaSqKm <- rowSums(zonal[,2:6])
zonal$CatFast <- 0 # nothing got classified as "Fast"
zonal <- zonal[c("SITE_ID","CatWetAreaSqKm","CatVerySlow","CatSlow",
                 "CatModerate","CatFast","CatVeryFast")]
final <- merge(x=nrsa_join,y=zonal,by="SITE_ID",all.x=TRUE)
final[is.na(final)] <- 0
write.csv(final, 
          file=paste0(n_path,'/splitMetrics/WetlandMag.csv'),
          row.names = FALSE)
```

### Average Wetland Connectivity Magnitude
This is a continuous variable, rather than categorical, using either magnitude of overland flow or magnitude of shallow flow depending on wetland type.  Note also that magnitude shallow flow is in days and magnitude overland flow is in hours - convert to same units (hours)
```{r, eval=F}
wrk_tbl$MagSh_hrs <- wrk_tbl$MagSh*24
wrk_tbl$Mag_avg <- ifelse(
                      wrk_tbl$Type_Full=="Riparian", 
                      0, 
                      ifelse(
                        wrk_tbl$Type_Full=="Overland", 
                        wrk_tbl$MagOv, 
                        wrk_tbl$MagSh_hrs))

# aggregate results to NRSA SITE_ID
by_COMID <- wrk_tbl %>%
            group_by(SITE_ID) %>%
            summarize(CatWetAreaSqKm=sum(WetAreaSqKm),
                      CatAvgConMag=sum(Mag_avg*DrainAreaSqKm)/sum(DrainAreaSqKm))

zonal <- as.data.frame(by_COMID)
final <- merge(x=nrsa_join,y=zonal,by="SITE_ID",all.x=TRUE)
final[is.na(final)] <- 0
write.csv(final, 
          file = paste0(n_path,'/splitMetrics/WetlandMagAvg.csv'),
          row.names=FALSE)
```

### Dominant Wetland Connectivity Disturbance / Impact
```{r, eval=F}
# this is already done and written out ino the rds file now
# Ascribe Scott's type's to disturbance to get dominant disturbance
# wrk_tbl$Imp <- ifelse(
#                   wrk_tbl$Type=="Riparian",
#                   ifelse(
#                     rowSums(wrk_tbl[c("ImpDrImperv","ImpDrAg")])==0,
#                     "N",
#                     ifelse(
#                       wrk_tbl["ImpDrImperv"]<=5 & wrk_tbl["ImpDrAg"]<=5,
#                       "L",
#                       "H")),
#                   ifelse(
#                     rowSums(wrk_tbl[c("ImpPaAg","ImpPaLev","ImpPaCan")])==0,
#                     "N",
#                     ifelse(
#                       wrk_tbl["ImpDrImperv"]<=5 &
#                         wrk_tbl["ImpDrAg"]<=5 &
#                         wrk_tbl["ImpPaAg"]<=5 &
#                         wrk_tbl["ImpPaLev"]==0 &
#                         wrk_tbl["ImpPaCan"]==0,
#                       "L",
#                       "H")))

# aggregate results to NRSA SITE_ID
by_COMID <- wrk_tbl %>%
  group_by(SITE_ID, Imp) %>%
  summarize(CatDomTypeArea = sum(WetAreaSqKm))

by_COMID <- as.data.frame(by_COMID)
zonal <- by_COMID %>% spread(Imp, CatDomTypeArea)
names(zonal)[5] <- "Missing"
zonal[is.na(zonal)] <- 0
names(zonal)[2:5] <- c('CatHigh','CatLow','CatNone','CatMissing')
zonal$CatWetAreaSqKm <- rowSums(zonal[,2:5])
final <- merge(x=nrsa_join,y=zonal,by="SITE_ID",all.x=TRUE)
final[is.na(final)] <- 0
final <- final[,c("SITE_ID","CAT_COMID","CatWetAreaSqKm",
                  'CatHigh','CatLow','CatNone')]
write.csv(final, 
          file=paste0(n_path,'/splitMetrics/WetlandDist.csv'),
          row.names=FALSE)
```

### Sum nitrogen inputs for wetland drainage pixels
```{r, eval=F}
library(stringr)
library(purrr)
library(plyr)
library(foreign)

capwords <- function(s, strict = FALSE) {
  cap <- function(s) paste(toupper(substring(s, 1, 1)),
                {s <- substring(s, 2); if(strict) tolower(s) else s},
                           sep = "", collapse = " " )
  sapply(strsplit(s, split = " "), cap, USE.NAMES = !is.null(names(s)))
}

readDB <- function(file){
  df <- read.dbf(file, as.is=FALSE)
  names(df) <- toupper(names(df))
  return(df)
}

dbf_path = paste0(hm_path, 'SpatialDataInputs/Wetlands_NLCD',
                  year,'/WetlandCat/Zonal/')
variables <- list.files(dbf_path)
fromto_path <- paste0(hm_path,'/SpatialDataInputs/Wetlands_NLCD',
                      year,'/WetlandCat/FlowTables')
from_to <- list.files(fromto_path)

tables <- c('manure',
            'fert',
            'cbnf',
            'CMAQ',
            'PointN') # 

for (nm in tables){
  print(nm)
  zstats = variables[grep(nm,variables)] # clean out .cpg and .xml
  zstats <- zstats[!grepl('\\.xml$',zstats) & ! grepl('\\.cpg$',zstats)]
  result <- ldply(paste0(dbf_path,'/',zstats), readDB)
  names(result)[1] <- 'WetId'
  result <- merge(join_tbl, result, by='WetId', all.x=TRUE)
  
  if (nm != 'PointN'){
    idx <- which(!is.na(match(names(result),"AREA")))
    names(result)[idx] <- "DrainAreaSqKm"
    result$DrainAreaSqKm <- result$DrainAreaSqKm * 1e-6
    result$MEAN <- result$SUM / result$COUNT
    by_COMID <- result %>%
      group_by(SITE_ID) %>%
      dplyr::summarize(CatDrainAreaSqKm = sum(DrainAreaSqKm),
                       CatMean= sum((MEAN*DrainAreaSqKm) / sum(DrainAreaSqKm)),
                       CatLoad = CatMean * CatDrainAreaSqKm
                       )
  } else {
    by_COMID <- result %>%
      group_by(SITE_ID) %>%
      dplyr::summarize(CatSum= sum(SUM))
  }
  
  zonal = as.data.frame(by_COMID)
  if (nm != 'PointN'){names(zonal)[3] <- paste0('Cat', nm)
                      names(zonal)[4] <- paste0('Cat', nm, 'Load')}
  if (nm == 'PointN')names(zonal)[2] <- paste0('Cat',nm)
  zonal <- merge(nrsa_join, zonal, by='SITE_ID', all.x=TRUE)
  zonal[is.na(zonal)] <- 0
  up_nm <- capwords(nm)
  out <- paste0(hm_path,'splitMetrics/WetDrain',up_nm,'.csv')
  write.csv(zonal, 
            file=out,
            row.names=FALSE)
}
```
