---
title: "WetlandResultProcessingForStreamCat"
author: "Marc Weber"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    theme: yeti
    highlighted: default 
    toc: yes
---

## Calculate catchment wetlandarea-weighted average values

### Dominant Wetland Connectivity Type
```{r, eval=F}
library(dplyr)
library(tidyr)
year = '2011'
files_dir = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/FinalTables/WetlandTables')
zonal_dir = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/NitrogenModeling/Allocation_Accumulation'
rds_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/FinalTables/')
in_table <- readRDS(paste0(rds_path, 'WetConnectMetrics_',year,'.rds'))
head(in_table)
# aggregate results to NHDPlus catchment
by_COMID <- in_table %>%
  group_by(COMID, Type) %>%
  dplyr::summarize(CatDomTypeArea = sum(WetAreaSqKm))
  # filter(CatDomFlowArea == max(CatDomFlowArea))
head(by_COMID)
by_COMID = as.data.frame(by_COMID)
zonal <- by_COMID %>% spread(Type, CatDomTypeArea)
head(zonal)
names(zonal)[6] <- "Missing"
zonal[is.na(zonal)] <- 0
names(zonal)[2:6] <- c('CatOverland','CatRiparian','CatShallow','CatShallowDeep','CatMissing')
zonal$CatWetAreaSqKm <- rowSums(zonal[,2:6])
# get VPU
vpus <- read.csv('L:/Priv/CORFiles/Geospatial_Library/Data/Project/StreamCat/COMID_HydroRegion.csv')
head(vpus)
zonal$VPU <- vpus$VPU[match(zonal$COMID, vpus$COMID)]
# split out to VPU data frames for StreamCat zonal tables
X <- split(zonal, zonal$VPU)
lapply(1:length(X), function(i) write.csv(X[[i]][c(7,1:6)], 
                                      file = paste0(zonal_dir, '/WetlandType_', names(X[i]), ".csv"),
                                      row.names = FALSE))
```

### Dominant Wetland Connectivity Frequency
```{r, eval=F}
library(dplyr)
library(tidyr)
year = '2011'
files_dir = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/FinalTables/WetlandTables')
zonal_dir = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/NitrogenModeling/Allocation_Accumulation'
rds_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/FinalTables/')
in_table <- readRDS(paste0(rds_path, 'WetConnectMetrics_',year,'.rds'))
head(in_table)
# Ascribe Scott's type's to frequency to get dominant frequency
in_table$freq <- ifelse(in_table$Type=="Riparian" | in_table$FreqPa==1, "H", ifelse(in_table$FreqPa==.5, "M", "L"))
# No longer doing this way below..
# in_table$freq <- ifelse(in_table$Type=="Riparian" | in_table$Type=="Overland", ifelse(in_table$FreqOv>=-500, "H", ifelse(in_table$FreqOv>=-1000, "M", "L")),
#   ifelse(in_table$FreqSh==0, "H", ifelse(in_table$FreqSh==.5, "M", "L")))
table(in_table$freq)
# aggregate results to NHDPlus catchment
by_COMID <- in_table %>%
  group_by(COMID, freq) %>%
  dplyr::summarize(CatDomTypeArea = sum(WetAreaSqKm))
  # filter(CatDomFlowArea == max(CatDomFlowArea))
head(by_COMID)
by_COMID = as.data.frame(by_COMID)
zonal <- by_COMID %>% spread(freq, CatDomTypeArea)
head(zonal)
names(zonal)[5] <- "Missing"
zonal[is.na(zonal)] <- 0
names(zonal)[2:5] <- c('CatHighFreq','CatLowFreq','CatMedFreq','CatMissing')
zonal$CatWetAreaSqKm <- rowSums(zonal[,2:5])
# get VPU
vpus <- read.csv('L:/Priv/CORFiles/Geospatial_Library/Data/Project/StreamCat/COMID_HydroRegion.csv')
head(vpus)
zonal$VPU <- vpus$VPU[match(zonal$COMID, vpus$COMID)]
# split out to VPU data frames for StreamCat zonal tables
X <- split(zonal, zonal$VPU)
lapply(1:length(X), function(i) write.csv(X[[i]][c(1,6,3,4,2,5)], 
                                      file = paste0(zonal_dir, '/WetlandFreq_', names(X[i]), ".csv"),
                                      row.names = FALSE))
```

### Dominant Wetland Connectivity Magnitude
```{r, eval=F}
library(dplyr)
library(tidyr)
year = '2011'
files_dir = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/FinalTables/WetlandTables')
zonal_dir = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/NitrogenModeling/Allocation_Accumulation'
rds_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/FinalTables/')
in_table <- readRDS(paste0(rds_path, 'WetConnectMetrics_',year,'.rds'))
head(in_table)
# Ascribe Scott's type's to magnitude to get dominant magnitude
in_table$mag <- ifelse(in_table$Type=="Riparian", "VF",
  ifelse(in_table$Type=="Overland", ifelse(in_table$MagOv<=24, "VF", ifelse(in_table$MagOv/24<=14, "FA", "MO")),
  ifelse(in_table$MagSh<=1, "VF", ifelse(in_table$MagSh<=14, "FA", ifelse(in_table$MagSh/365.25<=1, "MO", ifelse(in_table$MagSh/365.25<=10, "SL", "VS"))))))
table(in_table$mag)
# aggregate results to NHDPlus catchment
by_COMID <- in_table %>%
  group_by(COMID, mag) %>%
  summarize(CatDomTypeArea = sum(WetAreaSqKm))
  # filter(CatDomFlowArea == max(CatDomFlowArea))
head(by_COMID)
by_COMID = as.data.frame(by_COMID)
zonal <- by_COMID %>% spread(mag, CatDomTypeArea)
head(zonal)
names(zonal)[7] <- "Missing"
zonal[is.na(zonal)] <- 0
names(zonal)[2:7] <- c('CatFast','CatModerate','CatSlow','CatVeryFast','CatVerySlow','CatMissing')
zonal$CatWetAreaSqKm <- rowSums(zonal[,2:7])
# get VPU
vpus <- read.csv('L:/Priv/CORFiles/Geospatial_Library/Data/Project/StreamCat/COMID_HydroRegion.csv')
head(vpus)
zonal$VPU <- vpus$VPU[match(zonal$COMID, vpus$COMID)]
# split out to VPU data frames for StreamCat zonal tables
X <- split(zonal, zonal$VPU)
lapply(1:length(X), function(i) write.csv(X[[i]][c(1,8,6,4,3,2,5)], 
                                      file = paste0(zonal_dir, '/WetlandMag_', names(X[i]), ".csv"),
                                      row.names = FALSE))
```

### Average Wetland Connectivity Magnitude
This is a continuous variable, rather than categorical, using either magnitude of overland flow or magnitude of shallow flow depending on wetland type.  Note also that magnitude shallow flow is in days and magnitude overland flow is in hours - convert to same units (hours)
```{r, eval=F}
library(dplyr)
library(tidyr)
year = '2011'
files_dir = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/FinalTables/WetlandTables')
zonal_dir = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/NitrogenModeling/Allocation_Accumulation'
rds_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/FinalTables/')
in_table <- readRDS(paste0(rds_path, 'WetConnectMetrics_',year,'.rds'))
head(in_table)
in_table$MagSh = in_table$MagSh*24
in_table$mag_avg <- ifelse(in_table$Type=="Riparian", 0, ifelse(in_table$Type=="Overland", in_table$MagOv, in_table$MagSh))
summary(in_table$mag_avg)
# aggregate results to NHDPlus catchment - this is an area-weighted average weighting by wetland drainage area
by_COMID <- in_table %>%
  group_by(COMID) %>%
  summarize(CatAvgConMag= (sum(mag_avg*DrainAreaSqKm)) / sum(DrainAreaSqKm), CatWetAreasSqKm = sum(WetAreaSqKm))
  # filter(CatDomFlowArea == max(CatDomFlowArea))
head(by_COMID)
zonal = as.data.frame(by_COMID)
zonal = zonal[c(1,3,2)]

# get VPU
vpus <- read.csv('L:/Priv/CORFiles/Geospatial_Library/Data/Project/StreamCat/COMID_HydroRegion.csv')
head(vpus)
zonal$VPU <- vpus$VPU[match(zonal$COMID, vpus$COMID)]
# split out to VPU data frames for StreamCat zonal tables
X <- split(zonal, zonal$VPU)
lapply(1:length(X), function(i) write.csv(X[[i]][c(1:3)], 
                                      file = paste0(zonal_dir, '/WetlandMagAvg_', names(X[i]), ".csv"),
                                      row.names = FALSE))
```

### Dominant Wetland Connectivity Disturbance / Impact
```{r, eval=F}
library(dplyr)
library(tidyr)
year = '2011'
files_dir = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/FinalTables/WetlandTables')
zonal_dir = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/NitrogenModeling/Allocation_Accumulation'
rds_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/FinalTables/')
in_table <- readRDS(paste0(rds_path, 'WetConnectMetrics_',year,'.rds'))
head(in_table)
# Ascribe Scott's type's to disturbance to get dominant disturbance
in_table$imp <- ifelse(in_table$Type=="Riparian", ifelse(rowSums(in_table[,18:19])==0, "N", ifelse(in_table[,18]<=5 & in_table[,19]<=5, "L", "H")),
  ifelse(rowSums(in_table[,20:22])==0, "N", ifelse(in_table[,18]<=5 & in_table[,19]<=5 & in_table[,20]<=5 & in_table[,21]==0 & in_table[,22]==0, "L", "H")))
table(in_table$imp)
# aggregate results to NHDPlus catchment
by_COMID <- in_table %>%
  group_by(COMID, imp) %>%
  summarize(CatDomTypeArea = sum(WetAreaSqKm))
  # filter(CatDomFlowArea == max(CatDomFlowArea))
head(by_COMID)
by_COMID = as.data.frame(by_COMID)
zonal <- by_COMID %>% spread(imp, CatDomTypeArea)
head(zonal)
names(zonal)[5] <- "Missing"
zonal[is.na(zonal)] <- 0
names(zonal)[2:5] <- c('CatHigh','CatLow','CatNone','CatMissing')
zonal$CatWetAreaSqKm <- rowSums(zonal[,2:5])
# get VPU
vpus <- read.csv('L:/Priv/CORFiles/Geospatial_Library/Data/Project/StreamCat/COMID_HydroRegion.csv')
head(vpus)
zonal$VPU <- vpus$VPU[match(zonal$COMID, vpus$COMID)]
# split out to VPU data frames for StreamCat zonal tables
X <- split(zonal, zonal$VPU)
lapply(1:length(X), function(i) write.csv(X[[i]][c(1,6,3,2,4)], 
                                      file = paste0(zonal_dir, '/WetlandDist_', names(X[i]), ".csv"),
                                      row.names = FALSE))
```

### Nitrogen inputs for wetland drainage pixels
```{r, eval=F}
library(tidyr)
library(stringr)
library(purrr)
year = '2011'
library(plyr)
library(foreign)
table_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/WetlandCat/Zonal/')
tables = c('manure_', 'fert_', 'cbnf_', 'CMAQ_', 'PointN_')
variables=list.files(table_path)

allwet <- readRDS(paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/FinalTables/WetConnectMetrics_',year,'.rds'))

readDB <- function(file){
  df <- read.dbf(file, as.is=FALSE)
  names(df) <- toupper(names(df))
  return(df)
}

for (k in 1:length(tables)){
  print(tables[k])
  cur_list =variables[grep(tables[k],variables)]
  cur_list = cur_list[!grepl('\\.xml$',cur_list) & ! grepl('\\.cpg$',cur_list)]
  result <- ldply(paste0(table_path,cur_list), readDB)
  if (k != 5) result <- result[!is.na(result$COUNT),]
  # Issue of NAs with CMAQ data
  if (k==5) final = result
  if (k!=5) final <- result[c('VALUE','COUNT','AREA','SUM')]
  names(final)[1] <- 'WetId'
  final$State <- allwet$State[match(final$WetId, allwet$WetId)]
  final$COMID <- allwet$COMID[match(final$WetId, allwet$WetId)]
  if (k !=5) final$MEAN <- final$SUM / final$COUNT
  if (k != 5) final <- final[c('WetId','COUNT','AREA','SUM','State','COMID','MEAN')]
  if (k != 5) names(final)[3] <- 'DrainAreaSqKm'
  if (k != 5) final$DrainAreaSqKm <- final$DrainAreaSqKm * 1e-6
  if (k ==5) final <- final[c('WetId','COMID','State','SUM')]
  temp <- final
  if (k != 5) names(temp)[6] <- str_replace(tables[k],"_","")
  if (k == 5) names(temp)[4] <- str_replace(tables[k],"_","")
  saveRDS(temp, file = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/FinalTables/',str_replace(tables[k],"_",""),'.rds'))

  zonal_dir = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/NitrogenModeling/Allocation_Accumulation'
  in_table <- final
  head(in_table)
  library(dplyr)
  # aggregate SumNitrogen to NHDPlus catchment
  if (k!=5){
  by_COMID <- in_table %>%
    group_by(COMID) %>%
    dplyr::summarize(CatMean= sum(MEAN*DrainAreaSqKm) / sum(DrainAreaSqKm), CatDrainAreaSqKm = sum(DrainAreaSqKm))
  by_COMID$CatLoad <- by_COMID$CatMean * (by_COMID$CatDrainAreaSqKm * 100) # Convert SqKm to Ha and then convert kg/ha/year to just kg
  }
  if (k==5){
  by_COMID <- in_table %>%
    group_by(COMID) %>%
    dplyr::summarize(CatSum= sum(SUM))
  }
  head(by_COMID)
  zonal = as.data.frame(by_COMID)
  
  capwords <- function(s, strict = FALSE) {
    cap <- function(s) paste(toupper(substring(s, 1, 1)),
                  {s <- substring(s, 2); if(strict) tolower(s) else s},
                             sep = "", collapse = " " )
    sapply(strsplit(s, split = " "), cap, USE.NAMES = !is.null(names(s)))
  }
  
  names(zonal)[2] <- paste0('Cat',capwords(str_replace(tables[k],"_","")))
  if (k!=5) names(zonal)[4] <- paste0('Cat',capwords(str_replace(tables[k],"_","")),'Load')
  # get VPU
  vpus <- read.csv('L:/Priv/CORFiles/Geospatial_Library/Data/Project/StreamCat/COMID_HydroRegion.csv')
  head(vpus)
  zonal$VPU <- vpus$VPU[match(zonal$COMID, vpus$COMID)]
  # split out to VPU data frames for StreamCat zonal tables
  X <- split(zonal, zonal$VPU)
  if (k!=5){
    lapply(1:length(X), function(i) write.csv(X[[i]][c(1,3,2,4)], 
                                      file = paste0(zonal_dir, '/WetDrain',capwords(str_replace(tables[k],"_","")),'_', names(X[i]), ".csv"),
                                      row.names = FALSE))
  }
  if (k==5){
    lapply(1:length(X), function(i) write.csv(X[[i]][c(1:2)], 
                                      file = paste0(zonal_dir, '/WetDrain',capwords(str_replace(tables[k],"_","")),'_', names(X[i]), ".csv"),
                                      row.names = FALSE))
  }
}
```

### Wetland-mitigated nitrogen output (from incremental path processing)
```{r, eval=F}
library(dplyr)
library(tidyr)
library(sf)
files_dir = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/NitrogenModeling/Incremental_N_Inputs'
zonal_dir = 'L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/NitrogenModeling/Allocation_Accumulation'
year = '2011'
rds_path = paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD',year,'/FinalTables/')
in_table <- readRDS(paste0(rds_path, 'WetConnectMetrics_',year,'.rds'))

variables=list.files(files_dir)
variables =variables[grep('N_WetlandOutput',variables)]
wet_out = variables[!grepl('freq',variables)]
freq_out = variables[grepl('freq',variables)]

for (i in 1:length(wet_out)){
  result <- read.csv(paste0(files_dir,'/',wet_out[i]))
  n_max <- max(result$Sequence)
  result <- subset(result, Sequence == n_max) # only keep results which output directly to stream (highest seq number)
  freq_result <- read.csv(paste0(files_dir,'/',freq_out[i]))
  freq_result <- subset(freq_result, Sequence == n_max) # only keep results which output directly to stream (highest seq number)
  result$COMID <- in_table$COMID[match(result$WET_ID, in_table$WetId)]
  path_only <- result[is.na(result$WET_ID),]
  paths <- st_read(paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPath/CostPaths/streamlinkendpoint_',substr(wet_out[i],17,19),'.shp'))
  COMIDS <- st_read('H:/NHDPlusV21/NHDPlusNationalData/NHDPlusV21_National_Seamless.gdb', layer='Catchment')
  paths <- st_transform(paths, st_crs(COMIDS))
  z <- st_join(paths, COMIDS)
  z <- z[c(2,4,9)]
  z$WETID <- ''
  z <- z[c(4,1,2,3)]
  names(z)[2:3] <- c('PATHID','COMID')
  z <- z[z$PATHID %in% path_only$PATHID,]
  z$N_out_kg <- path_only$N_out_kg[match(z$PATHID, path_only$PATHID)]
  z <- z[c(1:3,5,4)]
  z <- z[z$N_out_kg > 0,]
  names(z)[1] <- 'WET_ID'
  # now get wetpoints shapefile
  wetpoints <- st_read(paste0('L:/Priv/CORFiles/Geospatial_Library/Data/Project/WetlandConnectivity/SpatialDataInputs/Wetlands_NLCD2011/WetlandPoints/WetlandPoints',substr(wet_out[i],17,19),'.shp'))
  wetpoints <- st_transform(wetpoints, st_crs(z))
  wetpoints <- wetpoints[c(1,6)]
  names(wetpoints)[1] <- 'WET_ID'
  wetpoints$N_out_kg[wetpoints$WET_ID %in% result$WET_ID] <- result$N_out_kg[match(result$WET_ID[wetpoints$WET_ID %in% result$WET_ID], wetpoints$WET_ID)]
  wetpoints$PATHID[wetpoints$WET_ID %in% result$WET_ID] <- result$PATHID[match(result$WET_ID[wetpoints$WET_ID %in% result$WET_ID], wetpoints$WET_ID)]
  wetpoints$COMID[wetpoints$WET_ID %in% result$WET_ID] <- result$COMID[match(result$WET_ID[wetpoints$WET_ID %in% result$WET_ID], wetpoints$WET_ID)]
  wetpoints <- wetpoints[c(1,4,5,3,2)]
  wetpoints <- wetpoints[!is.na(wetpoints$N_out_kg),]
  # not combine
  wetpoints <- rbind(wetpoints, z)
  wetpoints$N_out_kg_freq1 <- freq_result$N_out_kg[match(wetpoints$PATHID,freq_result$PATHID)]
  st_write(wetpoints, paste0(zonal_dir,'/N_wetland_mitigated_',substr(wet_out[i],17,19),'.shp'))
}
```

